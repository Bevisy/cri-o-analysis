## CRI-O 服务生命周期全流程源码分析
本文主要分析 crio 服务本体的 “启动、运行、退出清理” 整个生命周期源码实现。

CRI-O 源码版本：[v1.31.0](https://github.com/Bevisy/cri-o/tree/1.31.0)

### 1. 函数入口 `main.main()`
```
> main.main() ./cmd/crio/main.go:118 (hits goroutine(1):1 total:1) (PC: 0x244ae96)
=> 118:	func main() {
```

### 2. 初始化日志组件：将 logrus logger 作为 klog 后端
```
> github.com/cri-o/cri-o/internal/log.InitKlogShim() ./internal/log/klog.go:15 (PC: 0x1cf9f4a)
Warning: debugging optimized function
    12:	// InitKlogShim creates a shim between logrus and klog by forwarding klog
    13:	// messages to the logrus logger. To reduce the overall verbosity we log every
    14:	// Info klog message in logrus Debug verbosity.
=>  15:	func InitKlogShim() {
    16:		klog.LogToStderr(false)
    17:		klog.SetLogger(logr.New(&logSink{}))
    18:	}
```

### 3. New crio App 对象，随后初始化各项参数
```
> main.main() ./cmd/crio/main.go:124 (PC: 0x244aec0)
=> 124:		app := cli.NewApp()
   125:
   126:		app.Name = "crio"
   127:		app.Usage = "OCI-based implementation of Kubernetes Container Runtime Interface"
   128:		app.Authors = []*cli.Author{{Name: "The CRI-O Maintainers"}}
   129:		app.UsageText = usage
```

查看 app 初始化后完整值如下：
```
("*github.com/urfave/cli/v2.App")(0xc0001e0200)
*github.com/urfave/cli/v2.App {
	Name: "crio",
	HelpName: "",
	Usage: "OCI-based implementation of Kubernetes Container Runtime Interfa...+2 more",
	UsageText: "OCI-based implementation of Kubernetes Container Runtime Interfa...+660 more",
	Args: false,
	ArgsUsage: "",
	Version: "1.31.0\nVersion:        1.31.0\nGitCommit:      a51dfb336a1d384741...+451 more",
	Description: "OCI-based implementation of Kubernetes Container Runtime Interfa...+2 more",
	DefaultCommand: "",
	Commands: []*github.com/urfave/cli/v2.Command len: 8, cap: 8, [
		*(*"github.com/urfave/cli/v2.Command")(0x3d75c60),
		*(*"github.com/urfave/cli/v2.Command")(0x3d75dc0),
		*(*"github.com/urfave/cli/v2.Command")(0x3d75f20),
		*(*"github.com/urfave/cli/v2.Command")(0x3d75b00),
		*(*"github.com/urfave/cli/v2.Command")(0x3d76080),
		*(*"github.com/urfave/cli/v2.Command")(0x3d76760),
		*(*"github.com/urfave/cli/v2.Command")(0x3d768c0),
		*(*"github.com/urfave/cli/v2.Command")(0x3d761e0),
	],
	Flags: []github.com/urfave/cli/v2.Flag len: 123, cap: 123, [
		...,
		...,
		...+59 more
	],
	EnableBashCompletion: false,
	HideHelp: false,
	HideHelpCommand: false,
	HideVersion: false,
	categories: github.com/urfave/cli/v2.CommandCategories nil,
	flagCategories: github.com/urfave/cli/v2.FlagCategories nil,
	BashComplete: github.com/urfave/cli/v2.DefaultAppComplete,
	Before: main.main.func1,
	After: nil,
	Action: main.main.func2,
	CommandNotFound: nil,
	OnUsageError: nil,
	InvalidFlagAccessHandler: nil,
	Compiled: time.Time(2024-05-22T17:37:08+08:00){
		wall: 484457559,
		ext: 63851967428,
		loc: *(*time.Location)(0x3e56760),},
	Authors: []*github.com/urfave/cli/v2.Author len: 1, cap: 1, [
		*(*"github.com/urfave/cli/v2.Author")(0xc00005a800),
	],
	Copyright: "",
	Reader: io.Reader(*os.File) *{
		file: *(*os.file)(0xc0001c4060),},
	Writer: io.Writer(*os.File) *{
		file: *(*os.file)(0xc0001c40c0),},
	ErrWriter: io.Writer(*os.File) *{
		file: *(*os.file)(0xc0001c4120),},
	ExitErrHandler: nil,
	Metadata: map[string]interface {} [
		"config": ...,
		"Env": *(*interface {})(0xc0002c1cb8),
	],
	ExtraInfo: nil,
	CustomAppHelpTemplate: "",
	SliceFlagSeparator: "",
	DisableSliceFlagSeparator: false,
	UseShortOptionHandling: false,
	Suggest: false,
	AllowExtFlags: false,
	SkipFlagParsing: false,
	didSetup: false,
	separator: github.com/urfave/cli/v2.separatorSpec {sep: "", disabled: false, customized: false},
	rootCommand: *github.com/urfave/cli/v2.Command nil,}
```

其中，app.Commands\[] 包`urfave/cli/v2`默认的子命令，此处还未注册 crio 实现的子命令，大致如下：
```
[]*github.com/urfave/cli/v2.Command len: 8, cap: 8, [
	*{
		Name: "complete",
		Aliases: []string len: 1, cap: 1, [
			"completion",
		],
		Usage: "Generate bash, fish or zsh completions.",
		UsageText: "",
		Description: "Output shell completion code for bash, zsh or fish.",
		Args: false,
		ArgsUsage: "SHELL",
		Category: "",
		BashComplete: nil,
		Before: nil,
		After: nil,
		Action: github.com/cri-o/cri-o/internal/criocli.init.completion.func5,
		OnUsageError: nil,
		Subcommands: []*github.com/urfave/cli/v2.Command len: 0, cap: 0, nil,
		Flags: []github.com/urfave/cli/v2.Flag len: 0, cap: 0, nil,
		flagCategories: github.com/urfave/cli/v2.FlagCategories nil,
		SkipFlagParsing: false,
		HideHelp: false,
		HideHelpCommand: false,
		Hidden: false,
		UseShortOptionHandling: false,
		HelpName: "",
		commandNamePath: []string len: 0, cap: 0, nil,
		CustomHelpTemplate: "",
		categories: github.com/urfave/cli/v2.CommandCategories nil,
		isRoot: false,
		separator: (*"github.com/urfave/cli/v2.separatorSpec")(0x3d75da0),},
	*{
		Name: "man",
		...},
	*{
		Name: "markdown",
		...},
	*{
		Name: "config",
		...},
	*{
		Name: "publish",
		...},
	*{
		Name: "version",
		...},
	*{
		Name: "wipe",
		...},
	*{
		Name: "status",
		...},
]
```

app.Flags 为初始化会的 crio 服务参数，均为默认值：
```
[]github.com/urfave/cli/v2.Flag len: 123, cap: 123, [
	*github.com/urfave/cli/v2.StringSliceFlag {
		Name: "absent-mount-sources-to-reject",
		...
	*github.com/urfave/cli/v2.BoolFlag {
		Name: "enable-tracing",
		Category: "",
		DefaultText: "",
		FilePath: "",
		Usage: "Enable OpenTelemetry trace data exporting.",
		Required: false,
		Hidden: false,
		HasBeenSet: false,
		Value: false,
		Destination: *bool nil,
		Aliases: []string len: 0, cap: 0, nil,
		EnvVars: []string len: 1, cap: 1, [
			"CONTAINER_ENABLE_TRACING",
		],
		defaultValue: false,
		defaultValueSet: false,
		Count: *int nil,
		DisableDefaultText: false,
		Action: nil,},
		...
```
需要关注字段：`Name`、`defaultValue`、`defaultValueSet`，例如，针对配置`enable-tracing`，默认值为`false`。
另外有个冷知识：Flags 参数数组以 Name 字段为关键字升序，但实际检索参数的时候，并没有根据这个特性做检索加速，检索函数算法时间复杂度依旧为 O(n)。

app.Action 为实际包含启动流程主要任务函数，此处不再展开，后面详细分析。

### 4. 初始化 app 完成，执行`app.Run()`运行 crio 服务
```
> main.main() ./cmd/crio/main.go:481 (PC: 0x244bb02)
=> 481:		if err := app.Run(os.Args); err != nil {
   482:			logrus.Fatal(err)
   483:		}
   484:	}
```

### 5. 进入包`github.com/urfave/cli/v2.(*App).RunContext()`，修改 crio 命令行参数，最终执行`app.Action()`
命令行参数存入`arguments`，最终存入 context `cCtx.Args()`被`app.Action()`消费。其中，包含参数解析、必要参数检查、参数校验等过程。
`argumets`和`cCtx.Args()`实际值：
```sh
# argumets 值为
[]string len: 9, cap: 9, [
	"/home/xxx.linux/go.linux/src/github.com/Bevisy/cri-o/bin...+5 more",
	"-l",
	"info",
	"--profile",
	"--profile-port=6060",
	"--profile-address=0.0.0.0",
	"--enable-tracing",
	"--tracing-endpoint=10.20.19.89:4317",
	"--tracing-sampling-rate-per-million=1000000",
]

# cCtx.Args() 函数体
args = github.com/urfave/cli/v2.Args
```

`app.Action()` 被调用，参数为`cCtx`。回到 crio main 包。
```
> github.com/urfave/cli/v2.(*Command).Run() ./vendor/github.com/urfave/cli/v2/command.go:276 (PC: 0x127d109)
=> 276:		err = c.Action(cCtx)
```

### 6. 进入crio main 包`app.Action()`流程
接上上文所提到的`app.Action()`，此处深入`app.Action()`分析。代码入口：
```
> main.main.func2() ./cmd/crio/main.go:215 (PC: 0x244bc56)
   214:
=> 215:		app.Action = func(c *cli.Context) error {
   216:			ctx, cancel := context.WithCancel(context.Background())
```

打印 `cCtx` 参数：
```
*github.com/urfave/cli/v2.Context {
	Context: context.Context(context.backgroundCtx) {
		emptyCtx: context.emptyCtx {},},
	App: *github.com/urfave/cli/v2.App {
		Name: "crio",
		HelpName: "crio",
		Usage: "OCI-based implementation of Kubernetes Container Runtime Interfa...+2 more",
		UsageText: "OCI-based implementation of Kubernetes Container Runtime Interfa...+660 more",
		Args: false,
		ArgsUsage: "",
		Version: "1.31.0\nVersion:        1.31.0\nGitCommit:      a51dfb336a1d384741...+451 more",
		Description: "OCI-based implementation of Kubernetes Container Runtime Interfa...+2 more",
		DefaultCommand: "",
		Commands: []*github.com/urfave/cli/v2.Command len: 9, cap: 16, [
			*(*"github.com/urfave/cli/v2.Command")(0x3d75c60),
			*(*"github.com/urfave/cli/v2.Command")(0x3d75dc0),
			*(*"github.com/urfave/cli/v2.Command")(0x3d75f20),
			*(*"github.com/urfave/cli/v2.Command")(0x3d75b00),
			*(*"github.com/urfave/cli/v2.Command")(0x3d76080),
			*(*"github.com/urfave/cli/v2.Command")(0x3d76760),
			*(*"github.com/urfave/cli/v2.Command")(0x3d768c0),
			*(*"github.com/urfave/cli/v2.Command")(0x3d761e0),
			*(*"github.com/urfave/cli/v2.Command")(0x3d76b80),
		],
		Flags: []github.com/urfave/cli/v2.Flag len: 125, cap: 255, [
			...,
			...,
			...+61 more
		],
		EnableBashCompletion: false,
		HideHelp: false,
		HideHelpCommand: false,
		HideVersion: false,
		categories: github.com/urfave/cli/v2.CommandCategories(*github.com/urfave/cli/v2.commandCategories) ...,
		flagCategories: github.com/urfave/cli/v2.FlagCategories(*github.com/urfave/cli/v2.defaultFlagCategories) ...,
		BashComplete: github.com/urfave/cli/v2.DefaultAppComplete,
		Before: main.main.func1,
		After: nil,
		Action: main.main.func2,
		CommandNotFound: nil,
		OnUsageError: nil,
		InvalidFlagAccessHandler: nil,
		Compiled: (*time.Time)(0xc0000f8118),
		Authors: []*github.com/urfave/cli/v2.Author len: 1, cap: 1, [
			*(*"github.com/urfave/cli/v2.Author")(0xc0000e2160),
		],
		Copyright: "",
		Reader: io.Reader(*os.File) ...,
		Writer: io.Writer(*os.File) ...,
		ErrWriter: io.Writer(*os.File) ...,
		ExitErrHandler: nil,
		Metadata: map[string]interface {} [...],
		ExtraInfo: nil,
		CustomAppHelpTemplate: "",
		SliceFlagSeparator: "",
		DisableSliceFlagSeparator: false,
		UseShortOptionHandling: false,
		Suggest: false,
		AllowExtFlags: false,
		SkipFlagParsing: false,
		didSetup: true,
		separator: (*"github.com/urfave/cli/v2.separatorSpec")(0xc0000f81c8),
		rootCommand: *(*"github.com/urfave/cli/v2.Command")(0xc000264580),},
	Command: *github.com/urfave/cli/v2.Command {
		Name: "crio",
		Aliases: []string len: 0, cap: 0, nil,
		Usage: "OCI-based implementation of Kubernetes Container Runtime Interfa...+2 more",
		UsageText: "OCI-based implementation of Kubernetes Container Runtime Interfa...+660 more",
		Description: "OCI-based implementation of Kubernetes Container Runtime Interfa...+2 more",
		Args: false,
		ArgsUsage: "",
		Category: "",
		BashComplete: github.com/urfave/cli/v2.DefaultAppComplete,
		Before: main.main.func1,
		After: nil,
		Action: main.main.func2,
		OnUsageError: nil,
		Subcommands: []*github.com/urfave/cli/v2.Command len: 9, cap: 16, [
			*(*"github.com/urfave/cli/v2.Command")(0x3d75c60),
			*(*"github.com/urfave/cli/v2.Command")(0x3d75dc0),
			*(*"github.com/urfave/cli/v2.Command")(0x3d75f20),
			*(*"github.com/urfave/cli/v2.Command")(0x3d75b00),
			*(*"github.com/urfave/cli/v2.Command")(0x3d76080),
			*(*"github.com/urfave/cli/v2.Command")(0x3d76760),
			*(*"github.com/urfave/cli/v2.Command")(0x3d768c0),
			*(*"github.com/urfave/cli/v2.Command")(0x3d761e0),
			*(*"github.com/urfave/cli/v2.Command")(0x3d76b80),
		],
		Flags: []github.com/urfave/cli/v2.Flag len: 125, cap: 255, [
			...,
			...,
			...+61 more
		],
		flagCategories: github.com/urfave/cli/v2.FlagCategories(*github.com/urfave/cli/v2.defaultFlagCategories) ...,
		SkipFlagParsing: false,
		HideHelp: false,
		HideHelpCommand: false,
		Hidden: false,
		UseShortOptionHandling: false,
		HelpName: "crio",
		commandNamePath: []string len: 0, cap: 0, nil,
		CustomHelpTemplate: "",
		categories: github.com/urfave/cli/v2.CommandCategories(*github.com/urfave/cli/v2.commandCategories) ...,
		isRoot: true,
		separator: (*"github.com/urfave/cli/v2.separatorSpec")(0xc0002646c0),},
	shellComplete: false,
	flagSet: *flag.FlagSet {
		Usage: flag.(*FlagSet).defaultUsage-fm,
		name: "crio",
		parsed: true,
		actual: map[string]*flag.Flag [...],
		formal: map[string]*flag.Flag [...],
		args: []string len: 0, cap: 0, [],
		errorHandling: ContinueOnError (0),
		output: io.Writer(io.discard) *(*io.Writer)(0xc0004dc130),
		undef: map[string]string nil,},
	parentContext: *github.com/urfave/cli/v2.Context {
		Context: context.Context(context.backgroundCtx) *(*context.Context)(0xc000339200),
		App: *github.com/urfave/cli/v2.App nil,
		Command: *github.com/urfave/cli/v2.Command nil,
		shellComplete: false,
		flagSet: *(*flag.FlagSet)(0xc0004dc070),
		parentContext: *github.com/urfave/cli/v2.Context nil,},}
```
解析`App.Flags`参数如下：
```
	*github.com/urfave/cli/v2.BoolFlag {
		Name: "enable-tracing",
		Category: "",
		DefaultText: "",
		FilePath: "",
		Usage: "Enable OpenTelemetry trace data exporting.",
		Required: false,
		Hidden: false,
		HasBeenSet: false,
		Value: false,
		Destination: *bool nil,
		Aliases: []string len: 0, cap: 0, nil,
		EnvVars: []string len: 1, cap: 1, [
			"CONTAINER_ENABLE_TRACING",
		],
		defaultValue: false,
		defaultValueSet: true,
		Count: *int nil,
		DisableDefaultText: false,
		Action: nil,},
```
对比前文提到的参数`enable-tracing`的`defaultValue`和`defaultValueSet`均为`false`，此处`defaultValueSet`参数为`true`，说明命令行参数生效。
另外，变量 `cCtx.App` 和 `cCtx.Command` 值完全一致，猜测是包`urfave/cli/v2`为了兼容性考虑。

准备 profile-cpu、profile-http，此处不赘述，实现如下：
```
> main.main.func2() ./cmd/crio/main.go:219 (PC: 0x244bd5a)
   218:			cpuProfilePath := c.String("profile-cpu")
=> 219:			if cpuProfilePath != "" {
   220:				logrus.Infof("Creating CPU profile in: %v", cpuProfilePath)
   221:
> main.main.func2() ./cmd/crio/main.go:240 (PC: 0x244c3eb)
   235:
   236:			if c.Bool("profile") {
   237:				profilePort := c.Int("profile-port")
   238:				profileAddress := c.String("profile-address")
   239:				profileEndpoint := fmt.Sprintf("%v:%v", profileAddress, profilePort)
=> 240:				go func() {
   241:					logrus.Debugf("Starting profiling server on %v", profileEndpoint)
   242:					if err := http.ListenAndServe(profileEndpoint, nil); err != nil {
   243:						logrus.Fatalf("Unable to run profiling server: %v", err)
   244:					}
   245:				}()
```

### 7. 将 cli.v2.App 参数格式化为 crio 需要的配置参数 config 并校验配置数据
```
> main.main.func2() ./cmd/crio/main.go:263 (PC: 0x244c8e9)
=> 263:			config, ok := c.App.Metadata["config"].(*libconfig.Config)
> main.main.func2() ./cmd/crio/main.go:270 (PC: 0x244c8f0)
=> 270:			if err := config.Validate(true); err != nil {
```

config 值如下：
```
("*github.com/cri-o/cri-o/pkg/config.Config")(0xc0000c6e08)
*github.com/cri-o/cri-o/pkg/config.Config {
	Comment: "# ",
	singleConfigPath: "/etc/crio/crio.conf",
	dropInConfigDir: "/etc/crio/crio.conf.d",
	RootConfig: github.com/cri-o/cri-o/pkg/config.RootConfig {
		Root: "/var/lib/containers/storage",
		RunRoot: "/run/containers/storage",
		ImageStore: "",
		Storage: "",
		StorageOptions: []string len: 0, cap: 0, nil,
		LogDir: "/var/log/crio/pods",
		VersionFile: "/var/run/crio/version",
		VersionFilePersist: "",
		CleanShutdownFile: "/var/lib/crio/clean.shutdown",
		InternalWipe: true,
		InternalRepair: false,},
	APIConfig: github.com/cri-o/cri-o/pkg/config.APIConfig {
		GRPCMaxSendMsgSize: 83886080,
		GRPCMaxRecvMsgSize: 83886080,
		Listen: "/var/run/crio/crio.sock",
		StreamAddress: "127.0.0.1",
		StreamPort: "0",
		StreamEnableTLS: false,
		StreamTLSCert: "",
		StreamTLSKey: "",
		StreamTLSCA: "",
		StreamIdleTimeout: "",},
	RuntimeConfig: github.com/cri-o/cri-o/pkg/config.RuntimeConfig {
		NoPivot: false,
		SELinux: false,
		LogToJournald: false,
		DropInfraCtr: true,
		ReadOnly: false,
		ConmonEnv: []string len: 0, cap: 0, nil,
		HooksDir: []string len: 1, cap: 1, [
			"/usr/share/containers/oci/hooks.d",
		],
		DefaultCapabilities: github.com/cri-o/cri-o/internal/config/capabilities.Capabilities len: 9, cap: 9, [
			"CHOWN",
			"DAC_OVERRIDE",
			"FSETID",
			"FOWNER",
			"SETGID",
			"SETUID",
			"SETPCAP",
			"NET_BIND_SERVICE",
			"KILL",
		],
		AddInheritableCapabilities: false,
		DefaultEnv: []string len: 0, cap: 0, nil,
		DefaultSysctls: []string len: 0, cap: 0, nil,
		DefaultUlimits: []string len: 0, cap: 0, nil,
		AllowedDevices: []string len: 1, cap: 1, [
			"/dev/fuse",
		],
		AdditionalDevices: []string len: 0, cap: 0, nil,
		CDISpecDirs: []string len: 2, cap: 2, [
			"/etc/cdi",
			"/var/run/cdi",
		],
		DeviceOwnershipFromSecurityContext: false,
		DefaultRuntime: "crun",
		DecryptionKeysPath: "/etc/crio/keys/",
		Conmon: "",
		ConmonCgroup: "",
		SeccompProfile: "",
		ApparmorProfile: "crio-default",
		BlockIOConfigFile: "",
		BlockIOReload: false,
		IrqBalanceConfigFile: "/etc/sysconfig/irqbalance",
		RdtConfigFile: "",
		CgroupManagerName: "systemd",
		DefaultMountsFile: "",
		ContainerExitsDir: "/var/run/crio/exits",
		ContainerAttachSocketDir: "/var/run/crio",
		BindMountPrefix: "",
		UIDMappings: "",
		MinimumMappableUID: -1,
		GIDMappings: "",
		MinimumMappableGID: -1,
		LogLevel: "info",
		LogFilter: "",
		NamespacesDir: "/var/run",
		PinnsPath: "",
		EnableCriuSupport: true,
		Runtimes: github.com/cri-o/cri-o/pkg/config.Runtimes [...],
		Workloads: github.com/cri-o/cri-o/pkg/config.Workloads nil,
		PidsLimit: -1,
		LogSizeMax: -1,
		CtrStopTimeout: 30,
		SeparatePullCgroup: "",
		InfraCtrCPUSet: "",
		SharedCPUSet: "",
		AbsentMountSourcesToReject: []string len: 0, cap: 0, nil,
		EnablePodEvents: false,
		IrqBalanceConfigRestoreFile: "/etc/sysconfig/orig_irq_banned_cpus",
		seccompConfig: *(*"github.com/cri-o/cri-o/internal/config/seccomp.Config")(0xc0000d2800),
		apparmorConfig: *(*"github.com/cri-o/cri-o/internal/config/apparmor.Config")(0xc000012b40),
		blockioConfig: *(*"github.com/cri-o/cri-o/internal/config/blockio.Config")(0xc0000d2820),
		rdtConfig: *(*"github.com/cri-o/cri-o/internal/config/rdt.Config")(0xc0002d2710),
		ulimitsConfig: *(*"github.com/cri-o/cri-o/internal/config/ulimits.Config")(0xc000012b70),
		deviceConfig: *(*"github.com/cri-o/cri-o/internal/config/device.Config")(0xc000012b58),
		cgroupManager: github.com/cri-o/cri-o/internal/config/cgmgr.CgroupManager(*github.com/cri-o/cri-o/internal/config/cgmgr.SystemdManager) ...,
		conmonManager: *github.com/cri-o/cri-o/internal/config/conmonmgr.ConmonManager nil,
		namespaceManager: *(*"github.com/cri-o/cri-o/internal/config/nsmgr.NamespaceManager")(0xc0000d2840),
		HostNetworkDisableSELinux: true,
		DisableHostPortMapping: false,
		Timezone: "",},
	ImageConfig: github.com/cri-o/cri-o/pkg/config.ImageConfig {
		DefaultTransport: "docker://",
		GlobalAuthFile: "",
		PauseImage: "registry.aliyuncs.com/google_containers/pause:3.9",
		PauseImageAuthFile: "",
		PauseCommand: "/pause",
		PinnedImages: []string len: 0, cap: 0, nil,
		SignaturePolicyPath: "/etc/crio/policy.json",
		SignaturePolicyDir: "/etc/crio/policies",
		InsecureRegistries: []string len: 0, cap: 0, nil,
		ImageVolumes: "mkdir",
		Registries: []string len: 0, cap: 0, nil,
		BigFilesTemporaryDir: "",
		AutoReloadRegistries: false,},
	NetworkConfig: github.com/cri-o/cri-o/pkg/config.NetworkConfig {
		CNIDefaultNetwork: "",
		NetworkDir: "/etc/cni/net.d/",
		PluginDir: "",
		PluginDirs: []string len: 1, cap: 1, [
			"/opt/cni/bin/",
		],
		cniManager: *github.com/cri-o/cri-o/internal/config/cnimgr.CNIManager nil,},
	MetricsConfig: github.com/cri-o/cri-o/pkg/config.MetricsConfig {
		EnableMetrics: false,
		MetricsCollectors: github.com/cri-o/cri-o/server/otel-collector/collectors.Collectors len: 16, cap: 16, [
			"image_pulls_layer_size",
			"containers_events_dropped_total",
			"containers_oom_total",
			"processes_defunct",
			"operations_total",
			"operations_latency_seconds",
			"operations_latency_seconds_total",
			"operations_errors_total",
			"image_pulls_bytes_total",
			"image_pulls_skipped_bytes_total",
			"image_pulls_failure_total",
			"image_pulls_success_total",
			"image_layer_reuse_total",
			"containers_oom_count_total",
			"containers_seccomp_notifier_count_total",
			"resources_stalled_at_stage",
		],
		MetricsHost: "127.0.0.1",
		MetricsPort: 9090,
		MetricsSocket: "",
		MetricsCert: "",
		MetricsKey: "",},
	TracingConfig: github.com/cri-o/cri-o/pkg/config.TracingConfig {
		EnableTracing: true,
		TracingEndpoint: "10.20.19.89:4317",
		TracingSamplingRatePerMillion: 1000000,},
	StatsConfig: github.com/cri-o/cri-o/pkg/config.StatsConfig {
		StatsCollectionPeriod: 0,
		CollectionPeriod: 0,
		IncludedPodMetrics: []string len: 0, cap: 0, nil,},
	NRI: *github.com/cri-o/cri-o/internal/config/nri.Config {
		Enabled: true,
		SocketPath: "/var/run/nri/nri.sock",
		PluginPath: "/opt/nri/plugins",
		PluginConfigPath: "/etc/nri/conf.d",
		PluginRegistrationTimeout: net.cacheMaxAge (5000000000),
		PluginRequestTimeout: github.com/containerd/nri/pkg/adaptation.DefaultPluginRequestTimeout (2000000000),
		DisableConnections: false,
		withTracing: false,},
	SystemContext: *github.com/containers/image/v5/types.SystemContext {
		RootForImplicitAbsolutePaths: "",
		SignaturePolicyPath: "",
		RegistriesDirPath: "",
		SystemRegistriesConfPath: "",
		SystemRegistriesConfDirPath: "",
		UserShortNameAliasConfPath: "",
		ShortNameMode: *github.com/containers/image/v5/types.ShortNameMode nil,
		PodmanOnlyShortNamesIgnoreRegistriesConfAndForceDockerHub: false,
		AuthFilePath: "",
		LegacyFormatAuthFilePath: "",
		DockerCompatAuthFilePath: "",
		ArchitectureChoice: "",
		OSChoice: "",
		VariantChoice: "",
		BlobInfoCacheDir: "",
		DockerArchiveAdditionalTags: []github.com/containers/image/v5/docker/reference.NamedTagged len: 0, cap: 0, nil,
		BigFilesTemporaryDir: "",
		OCICertPath: "",
		OCIInsecureSkipTLSVerify: false,
		OCISharedBlobDirPath: "",
		OCIAcceptUncompressedLayers: false,
		DockerCertPath: "",
		DockerPerHostCertDirPath: "",
		DockerInsecureSkipTLSVerify: OptionalBoolUndefined (0),
		DockerAuthConfig: *github.com/containers/image/v5/types.DockerAuthConfig nil,
		DockerBearerRegistryToken: "",
		DockerRegistryUserAgent: "cri-o/1.31.0 go/go1.22.3 os/linux arch/amd64",
		DockerDisableV1Ping: false,
		DockerDisableDestSchema1MIMETypes: false,
		DockerLogMirrorChoice: false,
		OSTreeTmpDirPath: "",
		DockerRegistryPushPrecomputeDigests: false,
		DockerDaemonCertPath: "",
		DockerDaemonHost: "",
		DockerDaemonInsecureSkipTLSVerify: false,
		DirForceCompress: false,
		DirForceDecompress: false,
		CompressionFormat: *github.com/containers/image/v5/pkg/compression/internal.Algorithm nil,
		CompressionLevel: *int nil,},}
```

将 config 值格式化为 tomlConfig 并打印，info 级别，方便服务配置检查，如下：
```
> main.main.func2() ./cmd/crio/main.go:288 (PC: 0x244cea7)
   287:			// Print the current configuration.
=> 288:			tomlConfig, err := config.ToString()
   289:			if err != nil {
   290:				logrus.Errorf("Unable to print current configuration: %v", err)
   291:			} else {
   292:				logrus.Infof("Current CRI-O configuration:\n%s", tomlConfig)
   293:			}
```

### 8. 启动服务监听`unix:///var/run/crio/crio.sock`
```
> main.main.func2() ./cmd/crio/main.go:295 (PC: 0x244d05d)
=> 295:			lis, err := server.Listen("unix", config.Listen)
```

修改`/var/run/crio/crio.sock`权限，从`0o755`到`0o660`，缩小用户范围：
```
> main.main.func2() ./cmd/crio/main.go:300 (PC: 0x244d249)
=> 300:			if err := os.Chmod(config.Listen, 0o660); err != nil {
   301:				logrus.Fatalf("Failed to chmod listen socket %s: %v", config.Listen, err)
   302:			}
```

### 9. trace 功能，支持 OpenTelemetry，默认不开启且只支持 gRPC 推流
```
> main.main.func2() ./cmd/crio/main.go:308 (PC: 0x244d420)
   303:
   304:			var (
   305:				tracerProvider *sdktrace.TracerProvider
   306:				opts           []otelgrpc.Option
   307:			)
=> 308:			if config.EnableTracing {
   309:				tracerProvider, opts, err = opentelemetry.InitTracing(
   310:					ctx,
   311:					config.TracingEndpoint,
   312:					config.TracingSamplingRatePerMillion,
   313:				)
```

### 10. 根据 config 新建 crioserver
```
> main.main.func2() ./cmd/crio/main.go:330 (PC: 0x244da3d)
=> 330:			crioServer, err := server.New(ctx, config)
```
进入 `server.New()`
```
# 创建`/var/run/crio`，此目录实际已存在(listen sock 阶段已创建目录)
> github.com/cri-o/cri-o/server.New() ./server/server.go:400 (PC: 0x2413eea)
=> 400:		if err := os.MkdirAll(config.ContainerAttachSocketDir, 0o755); err != nil {
   401:			return nil, err
   402:		}
# 目录"/var/run/crio/exits"，用于使用 inotify 监控容器退出
> github.com/cri-o/cri-o/server.New() ./server/server.go:405 (PC: 0x2413f0e)
   404:		// This is used to monitor container exits using inotify
=> 405:		if err := os.MkdirAll(config.ContainerExitsDir, 0o755); err != nil {
   406:			return nil, err
   407:		}
```

创建容器服务对象`containerServer`
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:408 (PC: 0x2413f37)
=> 408:		containerServer, err := lib.New(ctx, configIface)
   409:		if err != nil {
   410:			return nil, err
   411:		}
```

初始化 imageService、storageRuntimeService 等，例如，pause 容器配置、pull 和 manage 镜像的服务配置、Hooks 管理服务配置等
```
> github.com/cri-o/cri-o/internal/lib.New() ./internal/lib/container_server.go:143 (PC: 0x2352b88)
=> 143:		c := &ContainerServer{
   144:			runtime:              runtime,
   145:			store:                store,
   146:			storageImageServer:   imageService,
   147:			storageRuntimeServer: storageRuntimeService,
   148:			ctrNameIndex:         registrar.NewRegistrar(),
   149:			ctrIDIndex:           truncindex.NewTruncIndex([]string{}),
   150:			podNameIndex:         registrar.NewRegistrar(),
   151:			podIDIndex:           truncindex.NewTruncIndex([]string{}),
   152:			Hooks:                newHooks,
   153:			stateLock:            &sync.Mutex{},
   154:			state: &containerServerState{
   155:				containers:      oci.NewMemoryStore(),
   156:				infraContainers: oci.NewMemoryStore(),
   157:				sandboxes:       sandbox.NewMemoryStore(),
   158:				processLevels:   make(map[string]int),
   159:			},
   160:			config: config,
   161:		}
   162:		c.StatsServer = statsserver.New(ctx, c)
```

新建 Server 对象，包含如下服务和配置：
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:443 (PC: 0x24141b9)
=> 443:		s := &Server{
   444:			ContainerServer:          containerServer,
   445:			hostportManager:          hostportManager,
   446:			config:                   *config,
   447:			monitorsChan:             make(chan struct{}),
   448:			defaultIDMappings:        idMappings,
   449:			minimumMappableUID:       config.MinimumMappableUID,
   450:			minimumMappableGID:       config.MinimumMappableGID,
   451:			pullOperationsInProgress: make(map[pullArguments]*pullOperation),
   452:			resourceStore:            resourcestore.New(),
   453:		}
```

### 11. hostportManager（默认未开启）
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:423 (PC: 0x24140ac)
   421:		// Check for hostport mapping
   422:		var hostportManager hostport.HostPortManager
=> 423:		if config.RuntimeConfig.DisableHostPortMapping {
   424:			hostportManager = hostport.NewNoopHostportManager()
   425:		} else {
   426:			hostportManager = hostport.NewMetaHostportManager()
   427:		}
```

### 12. idMappings: 获取 config 中的 uid、gid 信息
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:429 (PC: 0x241412a)
=> 429:		idMappings, err := getIDMappings(config)
   430:		if err != nil {
   431:			return nil, err
   432:		}
```

### 13. rootless 模式：进程以非 root 权限运行
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:437 (PC: 0x241417f)
=> 437:		if os.Getenv(rootlessEnvName) == "" {
   438:			// Not running as rootless, reset XDG_RUNTIME_DIR and DBUS_SESSION_BUS_ADDRESS
   439:			os.Unsetenv("XDG_RUNTIME_DIR")
   440:			os.Unsetenv("DBUS_SESSION_BUS_ADDRESS")
   441:		}
```

### 14. EnablePodEvents 指定是否应生成容器 pod 级别事件，以优化 Kubelet 的 PLEG（Pod Lifecycle Event Generator）
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:454 (hits goroutine(1):1 total:1) (PC: 0x2414379)
=> 454:		if s.config.EnablePodEvents {
   455:			// creating a container events channel only if the evented pleg is enabled
   456:			s.ContainerEventsChan = make(chan types.ContainerEventResponse, 1000)
   457:		}
```

### 15. configureMaxThreads 设置 Go 运行时的最大线程阈值，该阈值为内核设置（来自 /proc/sys/kernel/threads-max）的 90%。
防止 Go 应用程序创建过多线程，从而耗尽系统资源（如内存和 CPU）。确保 Go 应用程序在大多数情况下不会超过系统的线程限制，从而避免潜在的系统级别问题
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:458 (PC: 0x24143c8)
=> 458:		if err := configureMaxThreads(); err != nil {
   459:			return nil, err
   460:		}
```

### 16. 服务启动尝试恢复 sandbox、container
restore 尝试恢复沙盒和容器。对于每个恢复失败的沙盒，它会启动一个清理程序，尝试调用 CNI DEL。对于每个恢复失败的容器，它会返回该容器的镜像，以便在使用 internal_wipe 时进行清理。
wipeIfAppropriate 接受一个镜像列表。如果配置的 VersionFilePersist 表明已经进行了升级，它会尝试清理该镜像列表。该操作是尽力而为的。
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:473 (PC: 0x24145e6)
=> 473:		deletedImages := s.restore(ctx)
   474:		s.wipeIfAppropriate(ctx, deletedImages)
```

### 17. 协程启动`s.stream.streamServer`（CRI 服务用到的流服务）
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:519 (PC: 0x2414b24)
   517:		s.stream.ctx = ctx
   518:		s.stream.runtimeServer = s
   519:		s.stream.streamServer, err = streaming.NewServer(streamServerConfig, s.stream)
   520:		if err != nil {
   521:			return nil, errors.New("unable to create streaming server")
   522:		}
   523:
   524:		s.stream.streamServerCloseCh = make(chan struct{})
=> 525:		go func() {
   526:			defer close(s.stream.streamServerCloseCh)
   527:			if err := s.stream.streamServer.Start(true); err != nil && !errors.Is(err, http.ErrServerClosed) {
   528:				log.Fatalf(ctx, "Failed to start streaming server: %v", err)
   529:			}
   530:		}()
```

### 18. 如果开启 metrics 配置，则初始化 metrics 服务
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:539 (PC: 0x2414db9)
Warning: debugging optimized function
   538:		// Start the metrics server if configured to be enabled
=> 539:		if s.config.EnableMetrics {
   540:			if err := metrics.New(&s.config.MetricsConfig).Start(s.monitorsChan); err != nil {
   541:				return nil, err
   542:			}
```

### 19. 启动 seccomp notifier watcher
用于监控和处理通过 seccomp 通知机制捕获的系统调用事件。
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:547 (PC: 0x2414e78)
=> 547:		if err := s.startSeccompNotifierWatcher(ctx); err != nil {
   548:			return nil, fmt.Errorf("start seccomp notifier watcher: %w", err)
   549:		}
```

### 20. 设置 NRI adaptation，启用 NRI 插件支持（默认开启，无配置项）
```
> github.com/cri-o/cri-o/server.New() ./server/server.go:562 (PC: 0x2414f21)
   551:		// Set up our NRI adaptation.
   552:		api, err := nriIf.New(s.config.NRI.WithTracing(s.config.EnableTracing))
   553:		if err != nil {
   554:			return nil, fmt.Errorf("failed to create NRI interface: %w", err)
   555:		}
   556:
   557:		s.nri = &nriAPI{
   558:			cri: s,
   559:			nri: api,
   560:		}
   561:
=> 562:		if err := s.nri.start(); err != nil {
```

### 21. 创建文件`/var/run/crio/version`（tmpfs 目录内，节点重启消失）
写入信息，用于判断 crio 版本是否升级
```
> main.main.func2() ./cmd/crio/main.go:337 (PC: 0x244dbed)
   335:			// Immediately upon start up, write our new version files
   336:			// we write one to a tmpfs, so we can detect when a node rebooted.
=> 337:			if err := info.WriteVersionFile(config.VersionFile); err != nil {
   338:				logrus.Fatal(err)
   339:			}
   340:			// we then write to a persistent directory. This is to check if crio has upgraded
   341:			// if it has, we should wipe images
   342:			if err := info.WriteVersionFile(config.VersionFilePersist); err != nil {
   343:				logrus.Fatal(err)
   344:			}
```

```
$ cat /var/run/crio/version
"1.31.0+a51dfb336a1d3847415dfa871e81d003e4ef79ae
```

### 22. 清理 unclean shutdown container 留下的多余文件
```
> main.main.func2() ./cmd/crio/main.go:375 (PC: 0x244e444)
   370:			}
   371:
   372:			// We always use 'Volatile: true' when creating containers, which means that in
   373:			// the event of an unclean shutdown, we might lose track of containers and layers.
   374:			// We need to call the garbage collection function to clean up the redundant files.
=> 375:			if err := crioServer.Store().GarbageCollect(); err != nil {
   376:				logrus.Errorf("Attempts to clean up unreferenced old container leftovers failed: %v", err)
   377:			}
```

### 23. 注册`RuntimeServiceServer`、`ImageServiceServer` grpc 服务
```
> main.main.func2() ./cmd/crio/main.go:379 (PC: 0x244e58f)
=> 379:			v1.RegisterRuntimeServiceServer(grpcServer, crioServer)
   380:			v1.RegisterImageServiceServer(grpcServer, crioServer)
```

`RuntimeServiceServer`:
```
var _RuntimeService_serviceDesc = grpc.ServiceDesc{
	ServiceName: "runtime.v1.RuntimeService",
	HandlerType: (*RuntimeServiceServer)(nil),
	Methods: []grpc.MethodDesc{
		{
			MethodName: "Version",
			Handler:    _RuntimeService_Version_Handler,
		},
		{
			MethodName: "RunPodSandbox",
			Handler:    _RuntimeService_RunPodSandbox_Handler,
		},
		{
			MethodName: "StopPodSandbox",
			Handler:    _RuntimeService_StopPodSandbox_Handler,
		},
		{
			MethodName: "RemovePodSandbox",
			Handler:    _RuntimeService_RemovePodSandbox_Handler,
		},
		{
			MethodName: "PodSandboxStatus",
			Handler:    _RuntimeService_PodSandboxStatus_Handler,
		},
		{
			MethodName: "ListPodSandbox",
			Handler:    _RuntimeService_ListPodSandbox_Handler,
		},
		{
			MethodName: "CreateContainer",
			Handler:    _RuntimeService_CreateContainer_Handler,
		},
		{
			MethodName: "StartContainer",
			Handler:    _RuntimeService_StartContainer_Handler,
		},
		{
			MethodName: "StopContainer",
			Handler:    _RuntimeService_StopContainer_Handler,
		},
		{
			MethodName: "RemoveContainer",
			Handler:    _RuntimeService_RemoveContainer_Handler,
		},
		{
			MethodName: "ListContainers",
			Handler:    _RuntimeService_ListContainers_Handler,
		},
		{
			MethodName: "ContainerStatus",
			Handler:    _RuntimeService_ContainerStatus_Handler,
		},
		{
			MethodName: "UpdateContainerResources",
			Handler:    _RuntimeService_UpdateContainerResources_Handler,
		},
		{
			MethodName: "ReopenContainerLog",
			Handler:    _RuntimeService_ReopenContainerLog_Handler,
		},
		{
			MethodName: "ExecSync",
			Handler:    _RuntimeService_ExecSync_Handler,
		},
		{
			MethodName: "Exec",
			Handler:    _RuntimeService_Exec_Handler,
		},
		{
			MethodName: "Attach",
			Handler:    _RuntimeService_Attach_Handler,
		},
		{
			MethodName: "PortForward",
			Handler:    _RuntimeService_PortForward_Handler,
		},
		{
			MethodName: "ContainerStats",
			Handler:    _RuntimeService_ContainerStats_Handler,
		},
		{
			MethodName: "ListContainerStats",
			Handler:    _RuntimeService_ListContainerStats_Handler,
		},
		{
			MethodName: "PodSandboxStats",
			Handler:    _RuntimeService_PodSandboxStats_Handler,
		},
		{
			MethodName: "ListPodSandboxStats",
			Handler:    _RuntimeService_ListPodSandboxStats_Handler,
		},
		{
			MethodName: "UpdateRuntimeConfig",
			Handler:    _RuntimeService_UpdateRuntimeConfig_Handler,
		},
		{
			MethodName: "Status",
			Handler:    _RuntimeService_Status_Handler,
		},
		{
			MethodName: "CheckpointContainer",
			Handler:    _RuntimeService_CheckpointContainer_Handler,
		},
		{
			MethodName: "ListMetricDescriptors",
			Handler:    _RuntimeService_ListMetricDescriptors_Handler,
		},
		{
			MethodName: "ListPodSandboxMetrics",
			Handler:    _RuntimeService_ListPodSandboxMetrics_Handler,
		},
		{
			MethodName: "RuntimeConfig",
			Handler:    _RuntimeService_RuntimeConfig_Handler,
		},
	},
	Streams: []grpc.StreamDesc{
		{
			StreamName:    "GetContainerEvents",
			Handler:       _RuntimeService_GetContainerEvents_Handler,
			ServerStreams: true,
		},
	},
	Metadata: "api.proto",
}
```

`ImageServiceServer`:
```
var _ImageService_serviceDesc = grpc.ServiceDesc{
	ServiceName: "runtime.v1.ImageService",
	HandlerType: (*ImageServiceServer)(nil),
	Methods: []grpc.MethodDesc{
		{
			MethodName: "ListImages",
			Handler:    _ImageService_ListImages_Handler,
		},
		{
			MethodName: "ImageStatus",
			Handler:    _ImageService_ImageStatus_Handler,
		},
		{
			MethodName: "PullImage",
			Handler:    _ImageService_PullImage_Handler,
		},
		{
			MethodName: "RemoveImage",
			Handler:    _ImageService_RemoveImage_Handler,
		},
		{
			MethodName: "ImageFsInfo",
			Handler:    _ImageService_ImageFsInfo_Handler,
		},
	},
	Streams:  []grpc.StreamDesc{},
	Metadata: "api.proto",
}
```

### 24. 协程启动 `crioServer.StartExitMonitor`，负责 watch 容器退出事件和更新容器状态
```
> main.main.func2() ./cmd/crio/main.go:385 (PC: 0x244e5dc)
=> 385:			go func() {
   386:				crioServer.StartExitMonitor(ctx)
   387:			}()
```

### 25. 协程启动 Hooks.Monitor()，监控管理`/usr/share/containers/oci/hooks.d`目录下的 hooks
```
> main.main.func2() ./cmd/crio/main.go:392 (PC: 0x244e6b5)
   387:			}()
   388:			hookSync := make(chan error, 2)
   389:			if crioServer.ContainerServer.Hooks == nil {
   390:				hookSync <- err // so we don't block during cleanup
   391:			} else {
=> 392:				go crioServer.ContainerServer.Hooks.Monitor(ctx, hookSync)
   393:				err = <-hookSync
   394:				if err != nil {
   395:					cancel()
   396:					logrus.Fatal(err)
   397:				}
```

hooks.Manager 值如下：
```
("*github.com/containers/common/pkg/hooks.Manager")(0xc002620040)
*github.com/containers/common/pkg/hooks.Manager {
	hooks: map[string]*github.com/containers/common/pkg/hooks/1%2e0%2e0.Hook [],
	directories: []string len: 1, cap: 1, [
		"/usr/share/containers/oci/hooks.d",
	],
	extensionStages: []string len: 0, cap: 0, [],
	lock: sync.Mutex {state: 0, sema: 0},}
```

### 26. 基于`unix:///var/run/crio/crio.sock`实例化新的多路连接复用器
初始化 grpc、http 服务配置。`catchShutdown()`协程监听信号`signals.Interrupt, signals.Term, unix.SIGUSR1, unix.SIGUSR2, unix.SIGPIPE, signals.Hup`以及处理对应服务的优雅关闭。
```
> main.main.func2() ./cmd/crio/main.go:400 (PC: 0x244e952)
=> 400:			m := cmux.New(lis)
   401:			grpcL := m.MatchWithWriters(cmux.HTTP2MatchHeaderFieldSendSettings("content-type", "application/grpc"))
   402:			httpL := m.Match(cmux.HTTP1Fast())
   403:
   404:			infoMux := crioServer.GetExtendInterfaceMux(c.Bool("enable-profile-unix-socket"))
   405:			httpServer := &http.Server{
   406:				Handler:     infoMux,
   407:				ReadTimeout: 5 * time.Second,
   408:			}
   409:
   410:			graceful := false
   411:			catchShutdown(ctx, cancel, grpcServer, tracerProvider, crioServer, httpServer, &graceful)
```

### 27. 启动两个协程分别监听 grpc 和 http 服务（grpc 服务将 tracing 推送到服务端；http 服务为：1. crioserver、2. profile 数据服务）
```
> main.main.func2() ./cmd/crio/main.go:418 (PC: 0x244ed09)
   413:			go func() {
   414:				if err := grpcServer.Serve(grpcL); err != nil {
   415:					logrus.Errorf("Unable to run GRPC server: %v", err)
   416:				}
   417:			}()
=> 418:			go func() {
   419:				if err := httpServer.Serve(httpL); err != nil {
   420:					logrus.Debugf("Closed http server")
   421:				}
   422:			}()
```

### 28. 通过 cmux 多路复用，分流 grpc 和 http 服务
```
> main.main.func2() ./cmd/crio/main.go:427 (PC: 0x244edaa)
   424:			serverCloseCh := make(chan struct{})
   425:			go func() {
   426:				defer close(serverCloseCh)
=> 427:				if err := m.Serve(); err != nil {
   428:					if graceful && strings.Contains(strings.ToLower(err.Error()), "use of closed network connection") {
   429:						err = nil
   430:					} else {
   431:						logrus.Errorf("Failed to serve grpc request: %v", err)
   432:					}
   433:				}
   434:			}()
```

### 29. select 主进程监听 channel - `streamServerCloseCh`,`serverMonitorsCh`,`serverCloseCh`，在收到任意 channel 退出信号后，优雅关闭全部服务
```
> main.main.func2() ./cmd/crio/main.go:436 (PC: 0x244ee9a)
=> 436:			streamServerCloseCh := crioServer.StreamingServerCloseChan()
   437:			serverMonitorsCh := crioServer.MonitorsCloseChan()
   438:			select {
   439:			case <-streamServerCloseCh:
   440:			case <-serverMonitorsCh:
   441:			case <-serverCloseCh:
   442:			}
```

### 30. 模拟信号 SIGTERM，`catchShutdown()`向全部服务（grpcServer, tracerProvider, crioServer, httpServer）执行关闭操作
```sh
sudo kill -s 15 {crio_pid}
```

### 31. 主进程执行`crioServer.Shutdown(ctx)`，再次关闭`crioServer`。关闭`crioServer`会有一些清理动作。
```
> main.main.func2() ./cmd/crio/main.go:444 (PC: 0x244efb3)
=> 444:			if err := crioServer.Shutdown(ctx); err != nil {
   445:				logrus.Warnf("Error shutting down service: %v", err)
   446:			}
   447:			cancel()
```

### 32. 依次读取各个 close channel，确保各个服务均关闭
```
> main.main.func2() ./cmd/crio/main.go:455 (PC: 0x244f1ba)
   450:			logrus.Debugf("Closed stream server")
   451:			<-serverMonitorsCh
   452:			logrus.Debugf("Closed monitors")
   453:			err = <-hookSync
   454:			if err == nil || errors.Is(err, context.Canceled) {
=> 455:				logrus.Debugf("Closed hook monitor")
   456:			} else {
   457:				logrus.Errorf("Hook monitor failed: %v", err)
   458:			}
   459:			<-serverCloseCh
   460:			logrus.Debugf("Closed main server")
```

### 33. 如果开启`profile-mem`，则在退出前生成 heap profile
```
> main.main.func2() ./cmd/crio/main.go:462 (PC: 0x244f2ee)
=> 462:			memProfilePath := c.String("profile-mem")
   463:			if memProfilePath != "" {
   464:				logrus.Infof("Creating memory profile in: %v", memProfilePath)
   465:
   466:				file, err := os.Create(memProfilePath)
```

### 34. app.Action() 结束，跳转至`github.com/urfave/cli/v2.(*Command).Run()`。随后按入栈逆序，函数逐个返回出栈，main.main 结束。最后 go runtime 负责清理全部进程空间，退出  crio 服务进程。
```
> github.com/urfave/cli/v2.(*Command).Run() ./vendor/github.com/urfave/cli/v2/command.go:276 (PC: 0x127d11d)
=> 276:		err = c.Action(cCtx)
   277:
   278:		cCtx.App.handleExitCoder(cCtx, err)
   279:		return err
   280:	}
```

### 35. crio 服务完全退出 :-)
```
Process 5857 has exited with status 0
```
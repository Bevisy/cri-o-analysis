# CRI-O Pod 创建流程源码分析
CRI-O 源码版本：[v1.31.0](https://github.com/Bevisy/cri-o/tree/1.31.0)

## 服务配置信息
```
xxx@lima-crio:~$ cat /etc/crio/crio.conf.d/10-crio.conf
[crio.image]
signature_policy = "/etc/crio/policy.json"
pause_image = "registry.aliyuncs.com/google_containers/pause:3.9"

[crio.runtime]
default_runtime = "crun"

[crio.runtime.runtimes.crun]
runtime_type = "pod"
runtime_path = "/usr/bin/crio-crun"
runtime_root = "/run/crun"
monitor_path = "/usr/bin/crio-conmonrs"
allowed_annotations = [
    "io.containers.trace-syscall",
]

[crio.runtime.runtimes.runc]
runtime_path = "/usr/bin/crio-runc"
runtime_root = "/run/runc"
monitor_path = "/usr/bin/crio-conmon"

xxx@lima-crio:~$ cat /etc/sysconfig/crio
	CRIO_RUNTIME_OPTIONS="--profile --profile-port=6060 --profile-address=0.0.0.0 --enable-tracing --tracing-endpoint='10.20.19.89:4317' --tracing-sampling-rate-per-million='1000000'"
```

## crictl 创建容器
kubectl 创建 pod 存在超时时间，失败后反复创建，不利于单步调试，于是采用 crictl 创建。
注意： kubelet 服务正常运行情况下，会主动清理 crictl 创建的 pod，为了避免 crictl 创建的 pod 被无缘无故删除，需要停止 kubelet 服务。

修改 /etc/crictl.yaml 配置，增加超时时间：
```
~# cat /etc/crictl.yaml
runtime-endpoint: "unix:///var/run/crio/crio.sock"
timeout: 360000
debug: true
```

crictl 创建 pod 步骤：
```
# pod-config.json
{
    "metadata": {
        "name": "nginx-sandbox",
        "namespace": "default",
        "attempt": 1,
        "uid": "hdishd83djaidwnduwk28bcsb"
    },
    "log_directory": "/tmp",
    "linux": {
    }
}

# container-config.json
{
  "metadata": {
      "name": "busybox-0"
  },
  "image":{
      "image": "docker.io/library/busybox:latest"
  },
  "command": [
      "sleep",
      "inf"
  ],
  "log_path":"busybox.0.log",
  "linux": {
  }
}

# 创建 sandbox，会得到 pod id
crictl runp pod-config.json

# 在 pod 内创建容器
crictl create {pod_id} container-config.json pod-config.json

# 启动容器
crictl start {container_id}
```

为了简化操作步骤，可直接如下：
```
crictl run container-config.json pod-config.json 
```

## 运行时服务 RuntimeService
## 运行 Pod Sandbox（RunPodSandbox）
### CRI-API: \_RuntimeService_RunPodSandbox_Handler
gRPC 服务注册后，gRPC 请求 \_RuntimeService_RunPodSandbox_Handler：
```
> k8s.io/cri-api/pkg/apis/runtime/v1._RuntimeService_RunPodSandbox_Handler() ./go.linux/src/github.com/Bevisy/cri-o/vendor/k8s.io/cri-api/pkg/apis/runtime/v1/api.pb.go:11247 (hits goroutine(27):1 total:1) (PC: 0x1e564b6)
  11246:
=>11247:	func _RuntimeService_RunPodSandbox_Handler(srv interface{}, ctx context.Context, dec func(interface{}) error, interceptor grpc.UnaryServerInterceptor) (interface{}, error) {
  11248:		in := new(RunPodSandboxRequest)
  11249:		if err := dec(in); err != nil {
  11250:			return nil, err
  11251:		}
  11252:		if interceptor == nil {
```
`_RuntimeService_RunPodSandbox_Handler`接受四个参数：服务实例 srv、上下文 ctx、解码器 dec、拦截器 interceptor，对应值分别为：
```
srv = interface {}(*github.com/cri-o/cri-o/server.Server) 0xc0006cd0a0
ctx = context.Context(*context.valueCtx) 0xc0006cd0b0
dec = google.golang.org/grpc.(*Server).processUnaryRPC.func2
interceptor = github.com/cri-o/cri-o/server/otel-collector.UnaryInterceptor.func1
```
在函数体中，首先创建了一个新的 RunPodSandboxRequest 实例 in，然后使用解码器 dec 对其进行解码。如果解码过程中出现错误，函数将返回错误。
接下来，如果没有设置拦截器，函数将直接调用服务的 RunPodSandbox 方法，并返回结果。否则，它将创建一个 grpc.UnaryServerInfo 实例 info，并定义一个处理器 handler，然后调用拦截器，将 ctx，in，info 和 handler 作为参数。

RunPodSandboxRequest 结构体包含了创建 PodSandbox 所需的配置信息，如 Config 和 RuntimeHandler。其中，Config 是 PodSandbox 的配置，RuntimeHandler 是要使用的运行时配置的名称。
```
type RunPodSandboxRequest struct {
	// Configuration for creating a PodSandbox.
	Config *PodSandboxConfig `protobuf:"bytes,1,opt,name=config,proto3" json:"config,omitempty"`
	// Named runtime configuration to use for this PodSandbox.
	// If the runtime handler is unknown, this request should be rejected.  An
	// empty string should select the default handler, equivalent to the
	// behavior before this feature was added.
	// See https://git.k8s.io/enhancements/keps/sig-node/585-runtime-class
	RuntimeHandler       string   `protobuf:"bytes,2,opt,name=runtime_handler,json=runtimeHandler,proto3" json:"runtime_handler,omitempty"`
	XXX_NoUnkeyedLiteral struct{} `json:"-"`
	XXX_sizecache        int32    `json:"-"`
}
```

#### otel-collector unitary 拦截器
```
> github.com/cri-o/cri-o/server/otel-collector.UnaryInterceptor.func1() ./go.linux/src/github.com/Bevisy/cri-o/server/otel-collector/interceptors.go:52 (PC: 0x32f88b6)
    50:
    51:	func UnaryInterceptor() grpc.UnaryServerInterceptor {
=>  52:		return func(
    53:			ctx context.Context,
    54:			req interface{},
    55:			info *grpc.UnaryServerInfo,
    56:			handler grpc.UnaryHandler,
    57:		) (interface{}, error) {
```
在这个拦截器中，首先记录了操作开始的时间，并从gRPC的UnaryServerInfo中获取了完整的方法名，然后使用filepath.Base函数获取了方法名的基本部分作为操作名。接着，使用opentelemetry.Tracer().Start函数开始一个新的追踪，并将请求名和ID添加到上下文中。然后，使用log.Debugf函数记录了请求的详细信息。
接下来，调用了处理程序handler来处理请求，并记录了响应和可能的错误。然后，使用metrics.Instance().MetricOperationsInc函数增加了操作的计数，使用metrics.Instance().MetricOperationsLatencySet函数设置了操作的延迟，使用metrics.Instance().MetricOperationsLatencyTotalObserve函数观察了操作的总延迟。
如果处理程序返回了错误，那么使用log.Debugf函数记录了错误信息，并使用metrics.Instance().MetricOperationsErrorsInc函数增加了操作错误的计数。如果没有错误，那么记录了响应的详细信息。
最后，结束了追踪并返回了响应和可能的错误。

关注 handler 部分，真正进入 \*Server.RunPodSandbox() 的实现。

### 实现代码入口 server.(\*Server).RunPodSandbox()：
```
> github.com/cri-o/cri-o/server.(*Server).RunPodSandbox() ./server/sandbox_run.go:67 (hits goroutine(61):1 total:1) (PC: 0x329fdce)
    65:
    66:	// RunPodSandbox creates and runs a pod-level sandbox.
=>  67:	func (s *Server) RunPodSandbox(ctx context.Context, req *types.RunPodSandboxRequest) (*types.RunPodSandboxResponse, error) {
    68:		// platform dependent call
    69:		return s.runPodSandbox(ctx, req)
    70:	}
```
此处查看 req 值如下：
```
("*k8s.io/cri-api/pkg/apis/runtime/v1.RunPodSandboxRequest")(0xc00024c320)
*k8s.io/cri-api/pkg/apis/runtime/v1.RunPodSandboxRequest {
	Config: *k8s.io/cri-api/pkg/apis/runtime/v1.PodSandboxConfig {
		Metadata: *(*"k8s.io/cri-api/pkg/apis/runtime/v1.PodSandboxMetadata")(0xc0004c7600),
		Hostname: "",
		LogDirectory: "/tmp",
		DnsConfig: *k8s.io/cri-api/pkg/apis/runtime/v1.DNSConfig nil,
		PortMappings: []*k8s.io/cri-api/pkg/apis/runtime/v1.PortMapping len: 0, cap: 0, nil,
		Labels: map[string]string nil,
		Annotations: map[string]string nil,
		Linux: *(*"k8s.io/cri-api/pkg/apis/runtime/v1.LinuxPodSandboxConfig")(0xc0004c7640),
		Windows: *k8s.io/cri-api/pkg/apis/runtime/v1.WindowsPodSandboxConfig nil,
		XXX_NoUnkeyedLiteral: struct {} {},
		XXX_sizecache: 0,},
	RuntimeHandler: "",
	XXX_NoUnkeyedLiteral: struct {} {},
	XXX_sizecache: 0,}
```

其中，Metadata 值包含定义的 Pod Name、Namespace、Attempt 和 Uid，Linux 包含初始化的值，如下：
```
# req.Config.Metadata
("*k8s.io/cri-api/pkg/apis/runtime/v1.PodSandboxMetadata")(0xc0004c7600)
*k8s.io/cri-api/pkg/apis/runtime/v1.PodSandboxMetadata {
	Name: "nginx-sandbox",
	Uid: "hdishd83djaidwnduwk28bcsb",
	Namespace: "default",
	Attempt: 1,
	XXX_NoUnkeyedLiteral: struct {} {},
	XXX_sizecache: 0,}
# req.Config.Linux
("*k8s.io/cri-api/pkg/apis/runtime/v1.LinuxPodSandboxConfig")(0xc0004c7640)
*k8s.io/cri-api/pkg/apis/runtime/v1.LinuxPodSandboxConfig {
	CgroupParent: "",
	SecurityContext: *k8s.io/cri-api/pkg/apis/runtime/v1.LinuxSandboxSecurityContext nil,
	Sysctls: map[string]string nil,
	Overhead: *k8s.io/cri-api/pkg/apis/runtime/v1.LinuxContainerResources nil,
	Resources: *k8s.io/cri-api/pkg/apis/runtime/v1.LinuxContainerResources nil,
	XXX_NoUnkeyedLiteral: struct {} {},
	XXX_sizecache: 0,}
```

### RunPodSandbox() 调用 server.(*Server).runPodSandbox() 实现具体功能
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:344 (PC: 0x32a505e)
   343:
=> 344:	func (s *Server) runPodSandbox(ctx context.Context, req *types.RunPodSandboxRequest) (resp *types.RunPodSandboxResponse, retErr error) {
   345:		ctx, span := log.StartSpan(ctx)
   346:		defer span.End()
   347:		sbox := sboxfactory.New()
   348:		if err := sbox.SetConfig(req.Config); err != nil {
   349:			return nil, fmt.Errorf("setting sandbox config: %w", err)
```

#### 进入 runPodSandbox()，跟踪其实现
接下来，将开始一个 700 行函数的分析 :-)

##### 创建跟踪 span
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:346 (PC: 0x32a5165)
   343:
   344:	func (s *Server) runPodSandbox(ctx context.Context, req *types.RunPodSandboxRequest) (resp *types.RunPodSandboxResponse, retErr error) {
   345:		ctx, span := log.StartSpan(ctx)
=> 346:		defer span.End()
   347:		sbox := sboxfactory.New()
   348:		if err := sbox.SetConfig(req.Config); err != nil {
   349:			return nil, fmt.Errorf("setting sandbox config: %w", err)
   350:		}
   351:
```

查看 span 值，为 opentelemetry 的 trace 信息，如下：
```
go.opentelemetry.io/otel/trace.Span(go.opentelemetry.io/otel/internal/global.nonRecordingSpan) {
	Span: go.opentelemetry.io/otel/trace/embedded.Span nil,
	sc: go.opentelemetry.io/otel/trace.SpanContext {
		traceID: go.opentelemetry.io/otel/trace.TraceID [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		spanID: go.opentelemetry.io/otel/trace.SpanID [0,0,0,0,0,0,0,0],
		traceFlags: 0,
		traceState: (*"go.opentelemetry.io/otel/trace.TraceState")(0xc0006fa510),
		remote: true,},
	tracer: *go.opentelemetry.io/otel/internal/global.tracer {
		Tracer: go.opentelemetry.io/otel/trace/embedded.Tracer nil,
		name: "",
		opts: []go.opentelemetry.io/otel/trace.TracerOption len: 0, cap: 0, nil,
		provider: *(*"go.opentelemetry.io/otel/internal/global.tracerProvider")(0xc0003fea50),
		delegate: (*"sync/atomic.Value")(0xc00052c220),},}
```

##### sandbox 实例初始化
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:347 (PC: 0x32a5202)
   343:
   344:	func (s *Server) runPodSandbox(ctx context.Context, req *types.RunPodSandboxRequest) (resp *types.RunPodSandboxResponse, retErr error) {
   345:		ctx, span := log.StartSpan(ctx)
   346:		defer span.End()
=> 347:		sbox := sboxfactory.New()
   348:		if err := sbox.SetConfig(req.Config); err != nil {
   349:			return nil, fmt.Errorf("setting sandbox config: %w", err)
   350:		}
   351:
```
sbox.SetConfig(req.Config) 设置并校验传入的 pod 参数。

sbox 值为：
```
github.com/cri-o/cri-o/internal/factory/sandbox.Sandbox(*github.com/cri-o/cri-o/internal/factory/sandbox.sandbox) *{
	config: *k8s.io/cri-api/pkg/apis/runtime/v1.PodSandboxConfig {
		Metadata: *(*"k8s.io/cri-api/pkg/apis/runtime/v1.PodSandboxMetadata")(0xc000720cc0),
		Hostname: "",
		LogDirectory: "/tmp",
		DnsConfig: *k8s.io/cri-api/pkg/apis/runtime/v1.DNSConfig nil,
		PortMappings: []*k8s.io/cri-api/pkg/apis/runtime/v1.PortMapping len: 0, cap: 0, nil,
		Labels: map[string]string [...],
		Annotations: map[string]string nil,
		Linux: *(*"k8s.io/cri-api/pkg/apis/runtime/v1.LinuxPodSandboxConfig")(0xc000720d00),
		Windows: *k8s.io/cri-api/pkg/apis/runtime/v1.WindowsPodSandboxConfig nil,
		XXX_NoUnkeyedLiteral: struct {} {},
		XXX_sizecache: 0,},
	id: "b119d73fcb9966289417d35106ca2d43a27aea5a234de15efd671507a2649922",
	name: "k8s_nginx-sandbox_default_hdishd83djaidwnduwk28bcsb_1",
	infra: github.com/cri-o/cri-o/internal/factory/container.Container nil,
	resolvPath: "",}
```

sbox.config.Metadata 包含创建 pod 设置的信息：
```
("*k8s.io/cri-api/pkg/apis/runtime/v1.PodSandboxMetadata")(0xc000720cc0)
*k8s.io/cri-api/pkg/apis/runtime/v1.PodSandboxMetadata {
	Name: "nginx-sandbox",
	Uid: "hdishd83djaidwnduwk28bcsb",
	Namespace: "default",
	Attempt: 1,
	XXX_NoUnkeyedLiteral: struct {} {},
	XXX_sizecache: 0,}
```

##### 初始化 resourceCleaner，将在错误时进行资源清理
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:366 (PC: 0x32a5847)
   365:
=> 366:		resourceCleaner := resourcestore.NewResourceCleaner()
   367:		defer func() {
   368:			// no error, no need to cleanup
   369:			if retErr == nil || isContextError(retErr) {
   370:				return
   371:			}
```
如果 retErr 不是 nil 也不是上下文错误，那么就调用 resourceCleaner.Cleanup() 方法进行资源清理。这个方法会遍历 ResourceCleaner 对象中的所有函数，并依次调用它们。如果任何一个函数返回错误，那么就立即返回这个错误。如果所有函数都成功执行，那么就返回 nil。
如果 resourceCleaner.Cleanup() 方法返回错误，那么就使用 log.Errorf(ctx, "Unable to cleanup: %v", err) 记录一条错误信息。Errorf(ctx context.Context, format string, args ...interface{}) 函数接收一个上下文、一个格式字符串和任意数量的参数，然后使用这些参数生成一条错误信息，并将其记录到日志中。
此后，将多次看到注册资源清理到 resourceCleaner。

##### s.ReservePodName 保存 pod 名称和 ID
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:377 (PC: 0x32a594f)
   376:
=> 377:		if _, err := s.ReservePodName(sbox.ID(), sbox.Name()); err != nil {
   378:			reservedID, getErr := s.PodIDForName(sbox.Name())
   379:			if getErr != nil {
   380:				return nil, fmt.Errorf("failed to get ID of pod with reserved name (%s), after failing to reserve name with %w: %w", sbox.Name(), getErr, getErr)
   381:			}
```
首先，尝试通过调用 s.ReservePodName(sbox.ID(), sbox.Name()) 来为给定的沙箱保留一个名称。如果这个操作失败，会尝试通过调用 s.PodIDForName(sbox.Name()) 来获取已经保留该名称的沙箱的 ID。如果这个操作也失败，那么会返回一个错误，说明无法获取已经保留该名称的沙箱的 ID。
如果能够获取到已经保留该名称的沙箱的 ID，那么会检查这个沙箱是否已经被创建。如果已经被创建，那么会认为这是一个重复的请求，直接返回这个沙箱。如果这个沙箱还没有被创建，那么会尝试通过调用 s.getResourceOrWait(ctx, sbox.Name(), "sandbox") 来获取或等待这个资源，等待时间时 4 分钟。如果这个操作成功，那么会返回这个沙箱。如果这个操作失败，那么会返回一个错误，说明无法获取或等待这个资源。

主要目的是确保沙箱的名称在整个系统中是唯一的，并且在沙箱被创建之前，这个名称已经被保留。这是为了防止在沙箱被创建的过程中，其他的请求尝试使用同样的名称来创建新的沙箱，从而导致名称冲突。

##### 注册 sbox.Name 清理，确保创建失败后，释放 sbox.Name
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:393 (PC: 0x32a6352)
   392:		}
=> 393:		resourceCleaner.Add(ctx, "runSandbox: releasing pod sandbox name: "+sbox.Name(), func() error {
   394:			s.ReleasePodName(sbox.Name())
   395:			return nil
   396:		})
```

##### 判断是否使用 hostNetwork
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:405 (PC: 0x32a65b6)
   404:		}
=> 405:		hostNetwork := securityContext.NamespaceOptions.Network == types.NamespaceMode_NODE
   406:
```
如果使用 hostNetwork，将跳过 CNI 插件准备阶段。此处，我们不是用 hostNetwork。

##### 判断 CNI 插件是否就绪，如果不 ready，将 watch 等待 cni 插件 ready，否则报错返回
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:407 (PC: 0x32a65d0)
   402:		if securityContext.NamespaceOptions == nil {
   403:			securityContext.NamespaceOptions = &types.NamespaceOption{}
   404:		}
   405:		hostNetwork := securityContext.NamespaceOptions.Network == types.NamespaceMode_NODE
   406:
=> 407:		if err := s.config.CNIPluginReadyOrError(); err != nil && !hostNetwork {
   408:			// if the cni plugin isn't ready yet, we should wait until it is
   409:			// before proceeding
   410:			watcher := s.config.CNIPluginAddWatcher()
   411:			log.Infof(ctx, "CNI plugin not ready. Waiting to create %s as it is not host network", sbox.Name())
   412:			if ready := <-watcher; !ready {
```

##### 校验 CRI 传递的 runtime handler，此处为空，直接返回空，无额外操作
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:420 (PC: 0x32a6a45)
   418:
   419:		// validate the runtime handler
=> 420:		runtimeHandler, err := s.runtimeHandler(req)
   421:		if err != nil {
   422:			return nil, err
   423:		}
```

##### （略过）无效注解过滤等

##### pod sandbox 中包含 pause 容器信息，并在创建后加入 resourceCleaner，便于出错后资源清理：
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:445 (PC: 0x32a6fba)
   440:
   441:		containerName, err := s.ReserveSandboxContainerIDAndName(sbox.Config())
   442:		if err != nil {
   443:			return nil, err
   444:		}
=> 445:		resourceCleaner.Add(ctx, "runSandbox: releasing container name: "+containerName, func() error {
   446:			s.ReleaseContainerName(ctx, containerName)
   447:			return nil
   448:		})
```

containerName 值为：
```
"k8s_POD_nginx-sandbox_default_hdishd83djaidwnduwk28bcsb_1"
```

##### 构建 podContainer
pause 容器信息构建
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:463 (PC: 0x32a7317)
   459:		pauseImage, err := s.config.ParsePauseImage()
   460:		if err != nil {
   461:			return nil, err
   462:		}
=> 463:		podContainer, err := s.StorageRuntimeServer().CreatePodSandbox(s.config.SystemContext,
   464:			sbox.Name(), sbox.ID(),
   465:			pauseImage,
   466:			s.config.PauseImageAuthFile,
   467:			containerName,
   468:			kubeName,
```

podContainer 值：
```
github.com/cri-o/cri-o/internal/storage.ContainerInfo {
	ID: "b119d73fcb9966289417d35106ca2d43a27aea5a234de15efd671507a2649922",
	Dir: "/var/lib/containers/storage/overlay-containers/b119d73fcb9966289...+56 more",
	RunDir: "/run/containers/storage/overlay-containers/b119d73fcb9966289417d...+52 more",
	Config: *github.com/opencontainers/image-spec/specs-go/v1.Image {
		Created: *(*time.Time)(0xc0007ca4e0),
		Author: "",
		Platform: (*"github.com/opencontainers/image-spec/specs-go/v1.Platform")(0xc000544c78),
		Config: (*"github.com/opencontainers/image-spec/specs-go/v1.ImageConfig")(0xc000544cd0),
		RootFS: (*"github.com/opencontainers/image-spec/specs-go/v1.RootFS")(0xc000544d68),
		History: []github.com/opencontainers/image-spec/specs-go/v1.History len: 4, cap: 4, [
			(*"github.com/opencontainers/image-spec/specs-go/v1.History")(0xc000574500),
			(*"github.com/opencontainers/image-spec/specs-go/v1.History")(0xc000574540),
			(*"github.com/opencontainers/image-spec/specs-go/v1.History")(0xc000574580),
			(*"github.com/opencontainers/image-spec/specs-go/v1.History")(0xc0005745c0),
		],},
	ProcessLabel: "",
	MountLabel: "",}
```


##### InfraContainer 实例初始化
完全的 pause 容器信息
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:508 (PC: 0x32a7f31)
   506:
   507:		// TODO: factor generating/updating the spec into something other projects can vendor
=> 508:		if err := sbox.InitInfraContainer(&s.config, &podContainer, sandboxIDMappings); err != nil {
   509:			return nil, err
   510:		}
```

##### 创建共享内存 shm 挂载点
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:561 (PC: 0x32a87d5)
   556:
   557:		// Remove the default /dev/shm mount to ensure we overwrite it
   558:		g.RemoveMount(libsandbox.DevShmPath)
   559:
   560:		// create shm mount for the pod containers.
=> 561:		s.resourceStore.SetStageForResource(ctx, sbox.Name(), "sandbox shm creation")
   562:		var shmPath string
   563:		if hostIPC {
   564:			shmPath = libsandbox.DevShmPath
```
首先，g.RemoveMount(libsandbox.DevShmPath) 调用 RemoveMount 函数来移除已经存在的共享内存挂载点。RemoveMount 函数通过遍历所有的挂载点，找到目标挂载点并移除。

接下来，根据 hostIPC 的值来决定 shmPath 的值。如果 hostIPC 为真，那么 shmPath 就是 libsandbox.DevShmPath。否则，shmPath 就需要创建新的共享内存挂载点。

在创建新的共享内存挂载点时，首先会获取共享内存的大小。如果 pod 的注解中有 annotations.ShmSizeAnnotation，那么就会解析这个注解的值作为共享内存的大小。解析注解的值时，会调用 resource.ParseQuantity(shmSizeStr) 函数，这个函数会解析一个表示数量的字符串，返回一个 Quantity 对象和一个错误。如果解析失败，就会返回一个错误。

然后，调用 sboxfactory.SetupShm(podContainer.RunDir, mountLabel, shmSize) 函数来设置共享内存。这个函数会创建一个新的目录作为共享内存的挂载点，然后挂载一个 tmpfs 文件系统到这个目录。如果挂载失败，就会返回一个错误。

接下来，如果 sandboxIDMappings 不为空，那么就会获取 sandbox 的用户和组 ID，然后调用 os.Chown(shmPath, rootPair.UID, rootPair.GID) 函数来改变共享内存挂载点的所有者。

```
shmPath = "/run/containers/storage/overlay-containers/b119d73fcb9966289417d...+56 more"
shmSize = 67108864 // 64 * 1024 * 1024 Byte
```

查看节点挂载信息如下：
```
shm on /run/containers/storage/overlay-containers/b119d73fcb9966289417d35106ca2d43a27aea5a234de15efd671507a2649922/userdata/shm type tmpfs (rw,nosuid,nodev,noexec,relatime,size=65536k,inode64)
```

名词解释：
共享内存（Shared Memory，简称 shm）是一种进程间通信（Inter-Process Communication，简称 IPC）的方式。它允许多个进程访问同一块内存空间，这些进程可以同时读写这块内存，从而实现数据的共享和交换。

##### 创建一个新的没有 container、infra container、network namespace 的 sandbox sb，此为真正用到的 sandbox 结构体
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:714 (PC: 0x32ab025)
   713:
=> 714:		sb, err := libsandbox.New(sbox.ID(), namespace, sbox.Name(), kubeName, logDir, labels, kubeAnnotations, processLabel, mountLabel, metadata, shmPath, cgroupParent, privileged, runtimeHandler, sbox.ResolvPath(), hostname, portMappings, hostNetwork, created, usernsMode, overhead, resources)
```
（省略大量参数准备过程）

最终，此处 sandbox 包含除 container、infra container、network namespace 的绝大部分信息，为后续实际创建 sandbox 做准备。

sb 值如下：
```
("*github.com/cri-o/cri-o/internal/lib/sandbox.Sandbox")(0xc00002f880)
*github.com/cri-o/cri-o/internal/lib/sandbox.Sandbox {
	criSandbox: *k8s.io/cri-api/pkg/apis/runtime/v1.PodSandbox {
		Id: "b119d73fcb9966289417d35106ca2d43a27aea5a234de15efd671507a2649922",
		Metadata: *(*"k8s.io/cri-api/pkg/apis/runtime/v1.PodSandboxMetadata")(0xc000720cc0),
		State: PodSandboxState_SANDBOX_READY (0),
		CreatedAt: 1716979740712954613,
		Labels: map[string]string [...],
		Annotations: map[string]string nil,
		RuntimeHandler: "",
		XXX_NoUnkeyedLiteral: struct {} {},
		XXX_sizecache: 0,},
	portMappings: []*github.com/cri-o/cri-o/internal/hostport.PortMapping len: 0, cap: 0, [],
	namespace: "default",
	name: "k8s_nginx-sandbox_default_hdishd83djaidwnduwk28bcsb_1",
	kubeName: "nginx-sandbox",
	logDir: "/tmp",
	containers: github.com/cri-o/cri-o/internal/oci.ContainerStorer(*github.com/cri-o/cri-o/internal/oci.memoryStore) *{
		s: map[string]*github.com/cri-o/cri-o/internal/oci.Container [],
		RWMutex: (*sync.RWMutex)(0xc00061c948),},
	processLabel: "",
	mountLabel: "",
	netns: github.com/cri-o/cri-o/internal/config/nsmgr.Namespace nil,
	ipcns: github.com/cri-o/cri-o/internal/config/nsmgr.Namespace nil,
	utsns: github.com/cri-o/cri-o/internal/config/nsmgr.Namespace nil,
	userns: github.com/cri-o/cri-o/internal/config/nsmgr.Namespace nil,
	shmPath: "/run/containers/storage/overlay-containers/b119d73fcb9966289417d...+56 more",
	cgroupParent: "",
	runtimeHandler: "",
	resolvPath: "/run/containers/storage/overlay-containers/b119d73fcb9966289417d...+64 more",
	hostnamePath: "",
	hostname: "b119d73fcb99",
	ips: []string len: 0, cap: 0, nil,
	seccompProfilePath: "",
	infraContainer: *github.com/cri-o/cri-o/internal/oci.Container nil,
	nsOpts: *k8s.io/cri-api/pkg/apis/runtime/v1.NamespaceOption nil,
	dnsConfig: *k8s.io/cri-api/pkg/apis/runtime/v1.DNSConfig {
		Servers: []string len: 0, cap: 0, nil,
		Searches: []string len: 0, cap: 0, nil,
		Options: []string len: 0, cap: 0, nil,
		XXX_NoUnkeyedLiteral: struct {} {},
		XXX_sizecache: 0,},
	stopMutex: sync.RWMutex {
		w: (*sync.Mutex)(0xc00002f9f0),
		writerSem: 0,
		readerSem: 0,
		readerCount: (*"sync/atomic.Int32")(0xc00002fa00),
		readerWait: (*"sync/atomic.Int32")(0xc00002fa04),},
	created: false,
	stopped: false,
	networkStopped: false,
	privileged: false,
	hostNetwork: false,
	usernsMode: "",
	containerEnvPath: "",
	podLinuxOverhead: *k8s.io/cri-api/pkg/apis/runtime/v1.LinuxContainerResources nil,
	podLinuxResources: *k8s.io/cri-api/pkg/apis/runtime/v1.LinuxContainerResources nil,}
```

##### 设置 namespaces
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:753 (PC: 0x32abc08)
   751:		// set up namespaces
   752:		s.resourceStore.SetStageForResource(ctx, sbox.Name(), "sandbox namespace creation")
=> 753:		nsCleanupFuncs, err := s.configureGeneratorForSandboxNamespaces(ctx, hostNetwork, hostIPC, hostPID, sandboxIDMappings, sysctls, sb, g)
```

包含如下 namespace：
```
	NETNS                NSType = "net"
	IPCNS                NSType = "ipc"
	UTSNS                NSType = "uts"
	USERNS               NSType = "user"
	PIDNS                NSType = "pid"
```
如果 hostNetwork 为 true，则使用主机网络。

##### 网络命名空间已创建，配置网络
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:777 (PC: 0x32abf68)
   772:		// now that we have the namespaces, we should create the network if we're managing namespace Lifecycle
   773:		var ips []string
   774:		var result cnitypes.Result
   775:
   776:		s.resourceStore.SetStageForResource(ctx, sbox.Name(), "sandbox network creation")
=> 777:		ips, result, err = s.networkStart(ctx, sb)
   778:		if err != nil {
   779:			resourceCleaner.Add(ctx, nsCleanupDescription, nsCleanupFunc)
   780:			return nil, err
   781:		}

INFO[2024-05-28 11:18:52.528745476+08:00] Got pod network &{Name:nginx-sandbox Namespace:default ID:d23ea07c20b1d1fbd886fb088663e5a81cb6b82e2424ce38afb5b4490c1a4f93 UID:hdishd83djaidwnduwk28bcsb NetNS:/var/run/netns/26eb524c-7b6d-4412-9e43-d18bf18b0401 Networks:[] RuntimeConfig:map[crio:{IP: MAC: PortMappings:[] Bandwidth:<nil> IpRanges:[] CgroupPath: PodAnnotations:0xc00055c008}] Aliases:map[]}  file="ocicni/ocicni.go:810"
INFO[2024-05-28 11:18:52.528846443+08:00] Adding pod default_nginx-sandbox to CNI network "crio" (type=bridge)  file="ocicni/ocicni.go:561"
INFO[2024-05-28 11:18:52.593817285+08:00] Got pod network &{Name:nginx-sandbox Namespace:default ID:d23ea07c20b1d1fbd886fb088663e5a81cb6b82e2424ce38afb5b4490c1a4f93 UID:hdishd83djaidwnduwk28bcsb NetNS:/var/run/netns/26eb524c-7b6d-4412-9e43-d18bf18b0401 Networks:[] RuntimeConfig:map[crio:{IP: MAC: PortMappings:[] Bandwidth:<nil> IpRanges:[] CgroupPath: PodAnnotations:0xc00055c008}] Aliases:map[]}  file="ocicni/ocicni.go:810"
INFO[2024-05-28 11:18:52.594278348+08:00] Checking pod default_nginx-sandbox for CNI network crio (type=bridge)  file="ocicni/ocicni.go:707"
INFO[2024-05-28 11:18:52.626425139+08:00] Checking CNI network crio (config version=1.0.0)  file="ocicni/ocicni.go:744"
DEBU[2024-05-28 11:18:52.627008777+08:00] CNI setup result: &{1.0.0 [{Name:cni0 Mac:ea:68:8d:30:75:1e Sandbox:} {Name:veth8bfaaa82 Mac:5e:c8:96:de:39:76 Sandbox:} {Name:eth0 Mac:86:00:5f:22:b2:aa Sandbox:/var/run/netns/26eb524c-7b6d-4412-9e43-d18bf18b0401}] [{Interface:0xc0004ae300 Address:{IP:10.85.0.183 Mask:ffff0000} Gateway:10.85.0.1}] [{Dst:{IP:0.0.0.0 Mask:00000000} GW:<nil>}] {[]  [] []}}  file="server/sandbox_network.go:76" id=f7c6a8ac-028e-463f-af26-b8618c2ae56d name=/runtime.v1.RuntimeService/RunPodSandbox
DEBU[2024-05-28 11:18:52.627160825+08:00] Found POD IPs: [10.85.0.183]                  file="server/sandbox_network.go:124" id=f7c6a8ac-028e-463f-af26-b8618c2ae56d name=/runtime.v1.RuntimeService/RunPodSandbox
```

此次创建 ips 值为：
```
[]string len: 1, cap: 1, [
	"10.85.0.183",
]
```

#####  rootfs mountPoint 挂载
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:805 (PC: 0x32ac69d)
   804:
=> 805:		mountPoint, err := s.StorageRuntimeServer().StartContainer(sbox.ID())
   806:		if err != nil {
   807:			return nil, fmt.Errorf("failed to mount container %s in pod sandbox %s(%s): %w", containerName, sb.Name(), sbox.ID(), err)
   808:		}
DEBU[2024-05-28 11:30:47.158307608+08:00] Cached value indicated that volatile is being used  file="overlay/overlay.go:192"
DEBU[2024-05-28 11:30:47.158502026+08:00] overlay: mount_data=lowerdir=/var/lib/containers/storage/overlay/l/QUWVFDPW3PEJPITZLLFFRCDS3G,upperdir=/var/lib/containers/storage/overlay/9980b15f610261c6d9f8ab71c802904b708e3d7970b99d2e798fe470f6af31b9/diff,workdir=/var/lib/containers/storage/overlay/9980b15f610261c6d9f8ab71c802904b708e3d7970b99d2e798fe470f6af31b9/work,volatile  file="overlay/overlay.go:1826"
DEBU[2024-05-28 11:30:47.160215626+08:00] Mounted container "d23ea07c20b1d1fbd886fb088663e5a81cb6b82e2424ce38afb5b4490c1a4f93" at "/var/lib/containers/storage/overlay/9980b15f610261c6d9f8ab71c802904b708e3d7970b99d2e798fe470f6af31b9/merged"  file="storage/runtime.go:464"
```
调用 startContainer() 确保容器目录被挂载，并返回挂在路径。

mountPoint 值为：
```
"/var/lib/containers/storage/overlay/7b0be30d21af9ea89808238e2cf0...+43 more"
```

###### s.StorageRuntimeServer().StartContainer() 实现
```
> github.com/cri-o/cri-o/internal/storage.(*runtimeService).StartContainer() ./go.linux/src/github.com/Bevisy/cri-o/internal/storage/runtime.go:447 (PC: 0x2e3fe96)
   446:
=> 447:	func (r *runtimeService) StartContainer(idOrName string) (string, error) {
   448:		container, err := r.storageImageServer.GetStore().Container(idOrName)
   449:		if err != nil {
   450:			if errors.Is(err, storage.ErrContainerUnknown) {
   451:				return "", ErrInvalidContainerID
   452:			}
   
> github.com/cri-o/cri-o/internal/storage.(*runtimeService).StartContainer() ./go.linux/src/github.com/Bevisy/cri-o/internal/storage/runtime.go:459 (PC: 0x2e40134)
   454:		}
   455:		metadata := RuntimeContainerMetadata{}
   456:		if err := json.Unmarshal([]byte(container.Metadata), &metadata); err != nil {
   457:			return "", err
   458:		}
=> 459:		mountPoint, err := r.storageImageServer.GetStore().Mount(container.ID, metadata.MountLabel)
   460:		if err != nil {
   461:			logrus.Debugf("Failed to mount container %q: %v", container.ID, err)
   462:			return "", err
   463:		}

> github.com/containers/storage.(*store).Mount() ./go.linux/src/github.com/Bevisy/cri-o/vendor/github.com/containers/storage/store.go:2860 (PC: 0x22aee76)
  2855:		}
  2856:
  2857:		return s.mount(img.TopLayer, options)
  2858:	}
  2859:
=>2860:	func (s *store) Mount(id, mountLabel string) (string, error) {
  2861:		options := drivers.MountOpts{
  2862:			MountLabel: mountLabel,
  2863:		}
```
调用 r.storageImageServer.GetStore().Mount(container.ID, metadata.MountLabel) --> github.com/containers/storage.(*store).Mount() 实际挂载目录。

此时，节点已经拉起 crio-conmonrs 进程，但还未创建实际的 pause 容器：
```
      1   32969   32449    1751 pts/1      32474 Sl       0   0:00 /usr/bin/crio-conmonrs --runtime /usr/bin/crio-crun --runtime-dir /var/lib/containers/storage/overlay-containers/b119d73fcb9966289417d35106ca2d43a27aea5a234de15efd671507a2649922/userdata --runtime-root /run/crun --log-level info --log-driver systemd --cgroup-manager systemd --enable-tracing --tracing-endpoint http://10.20.19.89:4317
```

##### 配置 OOM Score、Linux CPU Share
oom score = -998 ：防止 infra container 被杀死
cpu share = 2
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:818 (PC: 0x32acc09)
   815:
   816:		// Set OOM score adjust of the infra container to be very low
   817:		// so it doesn't get killed.
=> 818:		g.SetProcessOOMScoreAdj(PodInfraOOMAdj)
   819:
   820:		g.SetLinuxResourcesCPUShares(PodInfraCPUshares)
   821:
```

##### 添加 mount：/etc/hostname、/dev/mqueue、/sys、/proc
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:850 (PC: 0x32ad499)
   845:			Type:        "bind",
   846:			Source:      hostnamePath,
   847:			Destination: "/etc/hostname",
   848:			Options:     []string{"ro", "bind", "nodev", "nosuid", "noexec"},
   849:		}
=> 850:		g.AddMount(mnt)
   851:		g.AddAnnotation(annotations.HostnamePath, hostnamePath)
   852:		sb.AddHostnamePath(hostnamePath)
   853:
```

##### 确定 runtime_type 类型
此处为 “pod”，默认值为“oci”
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:916 (PC: 0x32ae06f)
   915:
=> 916:		runtimeType, err := s.Runtime().RuntimeType(runtimeHandler)
   917:		if err != nil {
   918:			return nil, err
   919:		}
```

##### 根据前述配置，创建 oci container
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:932 (PC: 0x32ae7b3)
   927:		// In the case of kernel separated containers, we need the infra container to create the VM for the pod
   928:		if sb.NeedsInfra(s.config.DropInfraCtr) || podIsKernelSeparated {
   929:			log.Debugf(ctx, "Keeping infra container for pod %s", sbox.ID())
   930:			// pauseImage, as the userRequestedImage parameter, only shows up in CRI values we return.
   931:			container, err = oci.NewContainer(sbox.ID(), containerName, podContainer.RunDir, logPath, labels, g.Config.Annotations, kubeAnnotations, pauseImage.StringForOutOfProcessConsumptionOnly(), nil, nil, "", nil, sbox.ID(), false, false, false, runtimeHandler, podContainer.Dir, created, podContainer.Config.Config.StopSignal)
=> 932:			if err != nil {
   933:				return nil, err
   934:			}
```

##### 将 oci 容器写入 sandbox 的 InfraContainer 字段
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:958 (PC: 0x32aee4d)
   957:
=> 958:		if err := sb.SetInfraContainer(container); err != nil {
   959:			return nil, err
   960:		}
```

##### 落盘 pause 容器配置数据 config.json
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:966 (PC: 0x32aef74)
   965:
=> 966:		if err = g.SaveToFile(filepath.Join(podContainer.Dir, "config.json"), saveOptions); err != nil {
   967:			return nil, fmt.Errorf("failed to save template configuration for pod sandbox %s(%s): %w", sb.Name(), sbox.ID(), err)
   968:		}
   969:		if err = g.SaveToFile(filepath.Join(podContainer.RunDir, "config.json"), saveOptions); err != nil {
   970:			return nil, fmt.Errorf("failed to write runtime configuration for pod sandbox %s(%s): %w", sb.Name(), sbox.ID(), err)
   971:		}
```

落盘目录：
```
# podContainer.Dir
"/var/lib/containers/storage/overlay-containers/13486d03a6fd3acf5...+56 more"
# podContainer.RunDir
"/run/containers/storage/overlay-containers/13486d03a6fd3acf5436d...+52 more"
```

##### 添加 InfraContainer 信息到 cri-o server s
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:973 (PC: 0x32af657)
   972:
=> 973:		s.addInfraContainer(ctx, container)
```

s -- cri-o server 数据：
```
("*github.com/cri-o/cri-o/server.Server")(0xc0006ea008)
*github.com/cri-o/cri-o/server.Server {
	config: github.com/cri-o/cri-o/pkg/config.Config {
		Comment: "# ",
		singleConfigPath: "/etc/crio/crio.conf",
		dropInConfigDir: "/etc/crio/crio.conf.d",
		RootConfig: (*"github.com/cri-o/cri-o/pkg/config.RootConfig")(0xc0006ea038),
		APIConfig: (*"github.com/cri-o/cri-o/pkg/config.APIConfig")(0xc0006ea0d8),
		RuntimeConfig: (*"github.com/cri-o/cri-o/pkg/config.RuntimeConfig")(0xc0006ea160),
		ImageConfig: (*"github.com/cri-o/cri-o/pkg/config.ImageConfig")(0xc0006ea4a0),
		NetworkConfig: (*"github.com/cri-o/cri-o/pkg/config.NetworkConfig")(0xc0006ea580),
		MetricsConfig: (*"github.com/cri-o/cri-o/pkg/config.MetricsConfig")(0xc0006ea5d0),
		TracingConfig: (*"github.com/cri-o/cri-o/pkg/config.TracingConfig")(0xc0006ea638),
		StatsConfig: (*"github.com/cri-o/cri-o/pkg/config.StatsConfig")(0xc0006ea658),
		NRI: *(*"github.com/cri-o/cri-o/internal/config/nri.Config")(0xc000438a50),
		SystemContext: *(*"github.com/containers/image/v5/types.SystemContext")(0xc000116000),},
	stream: github.com/cri-o/cri-o/server.StreamService {
		ctx: context.Context(*context.cancelCtx) ...,
		runtimeServer: *(*"github.com/cri-o/cri-o/server.Server")(0xc0006ea008),
		streamServer: k8s.io/kubelet/pkg/cri/streaming.Server(*k8s.io/kubelet/pkg/cri/streaming.server) ...,
		streamServerCloseCh: chan struct {} {
			qcount: 0,
			dataqsiz: 0,
			buf: *[0]struct struct {} [],
			elemsize: 0,
			closed: 0,
			elemtype: *internal/abi.Type {Size_: 0, PtrBytes: 0, Hash: 3842252374, TFlag: TFlagExtraStar|TFlagRegularMemory (10), Alig
n_: 1, FieldAlign_: 1, Kind_: 25, Equal: runtime.memequal0, GCData: *0, Str: 83651, PtrToThis: 1068800},
			sendx: 0,
			recvx: 0,
			recvq: waitq<struct {}> {
				first: *(*sudog<struct {}>)(0xc00023d020),
				last: *(*sudog<struct {}>)(0xc00023d020),},
			sendq: waitq<struct {}> {
				first: *sudog<struct {}> nil,
				last: *sudog<struct {}> nil,},
			lock: runtime.mutex {
				lockRankStruct: runtime.lockRankStruct {},
				key: 0,},},
		Runtime: k8s.io/kubelet/pkg/cri/streaming.Runtime nil,},
	hostportManager: github.com/cri-o/cri-o/internal/hostport.HostPortManager(*github.com/cri-o/cri-o/internal/hostport.metaHostportManager) *
{
		ipv4HostportManager: github.com/cri-o/cri-o/internal/hostport.HostPortManager(*github.com/cri-o/cri-o/internal/hostport.hostportMa
nager) ...,
		ipv6HostportManager: github.com/cri-o/cri-o/internal/hostport.HostPortManager(*github.com/cri-o/cri-o/internal/hostport.hostportMa
nager) ...,},
	ContainerServer: *github.com/cri-o/cri-o/internal/lib.ContainerServer {
		runtime: *(*"github.com/cri-o/cri-o/internal/oci.Runtime")(0xc0006e2030),
		store: github.com/containers/storage.Store(*github.com/containers/storage.store) ...,
		storageImageServer: github.com/cri-o/cri-o/internal/storage.ImageServer(*github.com/cri-o/cri-o/internal/storage.imageService) ...
,
		storageRuntimeServer: github.com/cri-o/cri-o/internal/storage.RuntimeServer(*github.com/cri-o/cri-o/internal/storage.runtimeServic
e) ...,
		ctrNameIndex: *(*"github.com/cri-o/cri-o/internal/registrar.Registrar")(0xc000013410),
		ctrIDIndex: *(*"github.com/containers/storage/pkg/truncindex.TruncIndex")(0xc0006e2120),
		podNameIndex: *(*"github.com/cri-o/cri-o/internal/registrar.Registrar")(0xc000013440),
		podIDIndex: *(*"github.com/containers/storage/pkg/truncindex.TruncIndex")(0xc0006e21e0),
		Hooks: *(*"github.com/containers/common/pkg/hooks.Manager")(0xc0001fed80),
		StatsServer: *(*"github.com/cri-o/cri-o/internal/lib/stats.StatsServer")(0xc0000538c0),
		stateLock: sync.Locker(*sync.Mutex) ...,
		state: *(*"github.com/cri-o/cri-o/internal/lib.containerServerState")(0xc0001fee40),
		config: *(*"github.com/cri-o/cri-o/pkg/config.Config")(0xc0000be008),},
	monitorsChan: chan struct {} {
		qcount: 0,
		dataqsiz: 0,
		buf: *[0]struct struct {} [],
		elemsize: 0,
		closed: 0,
		elemtype: *internal/abi.Type {Size_: 0, PtrBytes: 0, Hash: 3842252374, TFlag: TFlagExtraStar|TFlagRegularMemory (10), Align_: 1, F
ieldAlign_: 1, Kind_: 25, Equal: runtime.memequal0, GCData: *0, Str: 83651, PtrToThis: 1068800},
		sendx: 0,
		recvx: 0,
		recvq: waitq<struct {}> {
			first: *(*sudog<struct {}>)(0xc00023cf60),
			last: *(*sudog<struct {}>)(0xc00023cfc0),},
		sendq: waitq<struct {}> {
			first: *sudog<struct {}> nil,
			last: *sudog<struct {}> nil,},
		lock: runtime.mutex {
			lockRankStruct: runtime.lockRankStruct {},
			key: 0,},},
	defaultIDMappings: *github.com/containers/storage/pkg/idtools.IDMappings nil,
	ContainerEventsChan: chan k8s.io/cri-api/pkg/apis/runtime/v1.ContainerEventResponse {},
	minimumMappableUID: -1,
	minimumMappableGID: -1,
	pullOperationsInProgress: map[github.com/cri-o/cri-o/server.pullArguments]*github.com/cri-o/cri-o/server.pullOperation [],
	pullOperationsLock: sync.Mutex {state: 0, sema: 0},
	resourceStore: *github.com/cri-o/cri-o/internal/resourcestore.ResourceStore {
		resources: map[string]*github.com/cri-o/cri-o/internal/resourcestore.Resource [...],
		timeout: github.com/cri-o/cri-o/internal/resourcestore.sleepTimeBeforeCleanup (60000000000),
		closeChan: chan struct {} {
			qcount: 0,
			dataqsiz: 1,
			buf: *[1]struct struct {} [
				{},
			],
			elemsize: 0,
			closed: 0,
			elemtype: *internal/abi.Type {Size_: 0, PtrBytes: 0, Hash: 3842252374, TFlag: TFlagExtraStar|TFlagRegularMemory (10), Alig
n_: 1, FieldAlign_: 1, Kind_: 25, Equal: runtime.memequal0, GCData: *0, Str: 83651, PtrToThis: 1068800},
			sendx: 0,
			recvx: 0,
			recvq: waitq<struct {}> {
				first: *(*sudog<struct {}>)(0xc000053200),
				last: *(*sudog<struct {}>)(0xc000053200),},
			sendq: waitq<struct {}> {
				first: *sudog<struct {}> nil,
				last: *sudog<struct {}> nil,},
			lock: runtime.mutex {
				lockRankStruct: runtime.lockRankStruct {},
				key: 0,},},
		closed: false,
		mutex: (*sync.Mutex)(0xc0006e2a0c),},
	seccompNotifierChan: chan github.com/cri-o/cri-o/internal/config/seccomp.Notification {
		qcount: 0,
		dataqsiz: 0,
		buf: *[0]github.com/cri-o/cri-o/internal/config/seccomp.Notification [],
		elemsize: 48,
		closed: 0,
		elemtype: *internal/abi.Type {Size_: 48, PtrBytes: 40, Hash: 2047186486, TFlag: TFlagUncommon|TFlagExtraStar|TFlagNamed (7), Align
_: 8, FieldAlign_: 8, Kind_: 25, Equal: type:.eq.github.com/cri-o/cri-o/internal/config/seccomp.Notification, GCData: *22, Str: 372680, PtrToThis:
 2738112},
		sendx: 0,
		recvx: 0,
		recvq: waitq<github.com/cri-o/cri-o/internal/config/seccomp.Notification> {
			first: *(*"sudog<github.com/cri-o/cri-o/internal/config/seccomp.Notification>")(0xc00038aba0),
			last: *(*"sudog<github.com/cri-o/cri-o/internal/config/seccomp.Notification>")(0xc00038aba0),},
		sendq: waitq<github.com/cri-o/cri-o/internal/config/seccomp.Notification> {
			first: *sudog<github.com/cri-o/cri-o/internal/config/seccomp.Notification> nil,
			last: *sudog<github.com/cri-o/cri-o/internal/config/seccomp.Notification> nil,},
		lock: runtime.mutex {
			lockRankStruct: runtime.lockRankStruct {},
			key: 0,},},
	seccompNotifiers: sync.Map {
		mu: (*sync.Mutex)(0xc0006ea730),
		read: (*"sync/atomic.Pointer[sync.readOnly]")(0xc0006ea738),
		dirty: map[interface {}]*sync.entry nil,
		misses: 0,},
	containerEventClients: sync.Map {
		mu: (*sync.Mutex)(0xc0006ea750),
		read: (*"sync/atomic.Pointer[sync.readOnly]")(0xc0006ea758),
		dirty: map[interface {}]*sync.entry nil,
		misses: 0,},
	containerEventStreamBroadcaster: sync.Once {
		done: (*"sync/atomic.Uint32")(0xc0006ea770),
		m: (*sync.Mutex)(0xc0006ea774),},
	nri: *github.com/cri-o/cri-o/server.nriAPI {
		cri: *(*"github.com/cri-o/cri-o/server.Server")(0xc0006ea008),
		nri: github.com/cri-o/cri-o/internal/nri.API(*github.com/cri-o/cri-o/internal/nri.local) ...,},}

```

sb -- kubernets sandbox 数据：
```
("*github.com/cri-o/cri-o/internal/lib/sandbox.Sandbox")(0xc0004ec1c0)
*github.com/cri-o/cri-o/internal/lib/sandbox.Sandbox {
	criSandbox: *k8s.io/cri-api/pkg/apis/runtime/v1.PodSandbox {
		Id: "13486d03a6fd3acf5436d525877da64b6381dfbebbaaf1f7f998a77d32778b8b",
		Metadata: *(*"k8s.io/cri-api/pkg/apis/runtime/v1.PodSandboxMetadata")(0xc0000f9840),
		State: PodSandboxState_SANDBOX_READY (0),
		CreatedAt: 1716984967186357843,
		Labels: map[string]string [...],
		Annotations: map[string]string nil,
		RuntimeHandler: "",
		XXX_NoUnkeyedLiteral: struct {} {},
		XXX_sizecache: 0,},
	portMappings: []*github.com/cri-o/cri-o/internal/hostport.PortMapping len: 0, cap: 0, [],
	namespace: "default",
	name: "k8s_nginx-sandbox_default_hdishd83djaidwnduwk28bcsb_1",
	kubeName: "nginx-sandbox",
	logDir: "/tmp",
	containers: github.com/cri-o/cri-o/internal/oci.ContainerStorer(*github.com/cri-o/cri-o/internal/oci.memoryStore) *{
		s: map[string]*github.com/cri-o/cri-o/internal/oci.Container [],
		RWMutex: (*sync.RWMutex)(0xc000348b48),},
	processLabel: "",
	mountLabel: "",
	netns: github.com/cri-o/cri-o/internal/config/nsmgr.Namespace(*github.com/cri-o/cri-o/internal/config/nsmgr.namespace) *{
		Mutex: (*sync.Mutex)(0xc000428100),
		ns: github.com/cri-o/cri-o/internal/config/nsmgr.NS(*github.com/containernetworking/plugins/pkg/ns.netNS) ...,
		closed: false,
		nsType: "net",
		nsPath: "/var/run/netns/4f79c34b-057f-4329-9331-782b91c54cf9",},
	ipcns: github.com/cri-o/cri-o/internal/config/nsmgr.Namespace(*github.com/cri-o/cri-o/internal/config/nsmgr.namespace) *{
		Mutex: (*sync.Mutex)(0xc0005edf00),
		ns: github.com/cri-o/cri-o/internal/config/nsmgr.NS(*github.com/containernetworking/plugins/pkg/ns.netNS) ...,
		closed: false,
		nsType: "ipc",
		nsPath: "/var/run/ipcns/4f79c34b-057f-4329-9331-782b91c54cf9",},
	utsns: github.com/cri-o/cri-o/internal/config/nsmgr.Namespace(*github.com/cri-o/cri-o/internal/config/nsmgr.namespace) *{
		Mutex: (*sync.Mutex)(0xc000428180),
		ns: github.com/cri-o/cri-o/internal/config/nsmgr.NS(*github.com/containernetworking/plugins/pkg/ns.netNS) ...,
		closed: false,
		nsType: "uts",
		nsPath: "/var/run/utsns/4f79c34b-057f-4329-9331-782b91c54cf9",},
	userns: github.com/cri-o/cri-o/internal/config/nsmgr.Namespace nil,
	shmPath: "/run/containers/storage/overlay-containers/13486d03a6fd3acf5436d...+56 more",
	cgroupParent: "",
	runtimeHandler: "",
	resolvPath: "/run/containers/storage/overlay-containers/13486d03a6fd3acf5436d...+64 more",
	hostnamePath: "/run/containers/storage/overlay-containers/13486d03a6fd3acf5436d...+61 more",
	hostname: "13486d03a6fd",
	ips: []string len: 0, cap: 0, nil,
	seccompProfilePath: "RuntimeDefault",
	infraContainer: *github.com/cri-o/cri-o/internal/oci.Container {
		criContainer: *(*"k8s.io/cri-api/pkg/apis/runtime/v1.Container")(0xc00071c080),
		volumes: []github.com/cri-o/cri-o/internal/oci.ContainerVolume len: 0, cap: 0, nil,
		name: "k8s_POD_nginx-sandbox_default_hdishd83djaidwnduwk28bcsb_1",
		logPath: "/tmp/13486d03a6fd3acf5436d525877da64b6381dfbebbaaf1f7f998a77d327...+9 more",
		runtimeHandler: "",
		bundlePath: "/run/containers/storage/overlay-containers/13486d03a6fd3acf5436d...+52 more",
		dir: "/var/lib/containers/storage/overlay-containers/13486d03a6fd3acf5...+56 more",
		stopSignal: "",
		imageName: *github.com/cri-o/cri-o/internal/storage/references.RegistryImageReference nil,
		imageID: *github.com/cri-o/cri-o/internal/storage.StorageImageID nil,
		mountPoint: "/var/lib/containers/storage/overlay/3390e517f7785a3d5281a03698e3...+43 more",
		seccompProfilePath: "",
		conmonCgroupfsPath: "",
		crioAnnotations: k8s.io/apimachinery/pkg/fields.Set [...],
		state: *(*"github.com/cri-o/cri-o/internal/oci.ContainerState")(0xc0001631d0),
		opLock: (*sync.RWMutex)(0xc00033dd50),
		spec: *(*"github.com/opencontainers/runtime-spec/specs-go.Spec")(0xc0006fce10),
		idMappings: *github.com/containers/storage/pkg/idtools.IDMappings nil,
		terminal: false,
		stdin: false,
		stdinOnce: false,
		created: false,
		spoofed: false,
		stopping: false,
		stopLock: (*sync.Mutex)(0xc00033dd80),
		stopTimeoutChan: chan int64 {
			qcount: 0,
			dataqsiz: 10,
			buf: *[10]int64 [0,0,0,0,0,0,0,0,0,0],
			elemsize: 8,
			closed: 0,
			elemtype: *internal/abi.Type {Size_: 8, PtrBytes: 0, Hash: 2580995395, TFlag: TFlagUncommon|TFlagExtraStar|TFlagNamed|TFla
gRegularMemory (15), Align_: 8, FieldAlign_: 8, Kind_: 6, Equal: runtime.memequal64, GCData: *0, Str: 14232, PtrToThis: 856960},
			sendx: 0,
			recvx: 0,
			recvq: waitq<int64> {
				first: *sudog<int64> nil,
				last: *sudog<int64> nil,},
			sendq: waitq<int64> {
				first: *sudog<int64> nil,
				last: *sudog<int64> nil,},
			lock: runtime.mutex {
				lockRankStruct: runtime.lockRankStruct {},
				key: 0,},},
		stopWatchers: []chan struct {} len: 0, cap: 0, [],
		pidns: github.com/cri-o/cri-o/internal/config/nsmgr.Namespace nil,
		restore: false,
		restoreArchivePath: "",
		restoreStorageImageID: *github.com/cri-o/cri-o/internal/storage.StorageImageID nil,
		resources: *(*"k8s.io/cri-api/pkg/apis/runtime/v1.ContainerResources")(0xc000426018),
		runtimePath: "",
		execPIDs: map[int]bool [],},
	nsOpts: *k8s.io/cri-api/pkg/apis/runtime/v1.NamespaceOption {
		Network: NamespaceMode_POD (0),
		Pid: NamespaceMode_POD (0),
		Ipc: NamespaceMode_POD (0),
		TargetId: "",
		UsernsOptions: *k8s.io/cri-api/pkg/apis/runtime/v1.UserNamespace nil,
		XXX_NoUnkeyedLiteral: struct {} {},
		XXX_sizecache: 0,},
	dnsConfig: *k8s.io/cri-api/pkg/apis/runtime/v1.DNSConfig {
		Servers: []string len: 0, cap: 0, nil,
		Searches: []string len: 0, cap: 0, nil,
		Options: []string len: 0, cap: 0, nil,
		XXX_NoUnkeyedLiteral: struct {} {},
		XXX_sizecache: 0,},
	stopMutex: sync.RWMutex {
		w: (*sync.Mutex)(0xc0004ec330),
		writerSem: 0,
		readerSem: 0,
		readerCount: (*"sync/atomic.Int32")(0xc0004ec340),
		readerWait: (*"sync/atomic.Int32")(0xc0004ec344),},
	created: false,
	stopped: false,
	networkStopped: false,
	privileged: false,
	hostNetwork: false,
	usernsMode: "",
	containerEnvPath: "/var/lib/containers/storage/overlay-containers/13486d03a6fd3acf5...+70 more",
	podLinuxOverhead: *k8s.io/cri-api/pkg/apis/runtime/v1.LinuxContainerResources nil,
	podLinuxResources: *k8s.io/cri-api/pkg/apis/runtime/v1.LinuxContainerResources nil,}
```

##### conmonrs 再次调用 crun
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:980 (PC: 0x32af845)
   979:		s.resourceStore.SetStageForResource(ctx, sbox.Name(), "sandbox container runtime creation")
=> 980:		if err := s.createContainerPlatform(ctx, container, sb.CgroupParent(), sandboxIDMappings); err != nil {
   981:			return nil, err
   982:		}
   983:

DEBU[2024-05-28 13:45:20.240937330+08:00] Running conmonrs with PID: 8243               file="oci/runtime_pod.go:79"
DEBU[2024-05-28 13:45:20.242824560+08:00] Using conmonrs version: 0.6.3, tag: v0.6.3, commit: 164af97800cc3eef9e975dd05e05f7f587f66359, build: 2024-05-25 01:23:57 +08:00, target: x86_64-unknown-linux-gnu, rustc 1.78.0 (9b00956e5 2024-04-29), cargo 1.78.0 (54d8815d0 2024-03-26)  file="oci/runtime_pod.go:107" id=f7c6a8ac-028e-463f-af26-b8618c2ae56d name=/runtime.v1.RuntimeService/RunPodSandbox
DEBU[2024-05-28 13:45:20.242993243+08:00] Running conmon under slice  and unitName crio-conmon-d23ea07c20b1d1fbd886fb088663e5a81cb6b82e2424ce38afb5b4490c1a4f93.scope  file="cgmgr/systemd_linux.go:202"
```

查看节点进程信息， crun 进程被拉起，如下：
```
      1    8243    8242    1786 pts/3       3818 Sl       0   0:00 /usr/bin/crio-conmonrs --runtime /usr/bin/crio-crun --runtime-dir /var/lib/containers/storage/overlay-containers/d23ea07c20b1d1fbd886fb088663e5a81cb6b82e2424ce38afb5b4490c1a4f93/userdata --runtime-root /run/crun --log-level debug --log-driver systemd --cgroup-manager systemd
   8243    8251    8251    8251 ?             -1 Ss       0   0:00  \_ /usr/bin/crio-crun --root=/run/crun --systemd-cgroup create --bundle /run/containers/storage/overlay-containers/d23ea07c20b1d1fbd886fb088663e5a81cb6b82e2424ce38afb5b4490c1a4f93/userdata --pid-file /run/containers/storage/overlay-containers/d23ea07c20b1d1fbd886fb088663e5a81cb6b82e2424ce38afb5b4490c1a4f93/userdata/pidfile d23ea07c20b1d1fbd886fb088663e5a81cb6b82e2424ce38afb5b4490c1a4f93
```

##### 检查是否存在 runtime hooks，存在则载入。如果有 prestart hook 则执行
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:984 (PC: 0x32af914)
   983:
=> 984:		hooks, err := runtimehandlerhooks.GetRuntimeHandlerHooks(ctx, &s.config, sb.RuntimeHandler(), sb.Annotations())
   985:		if err != nil {
   986:			return nil, fmt.Errorf("failed to get runtime handler %q hooks", sb.RuntimeHandler())
   987:		}
   988:		if hooks != nil {
   989:			if err := hooks.PreStart(ctx, container, sb); err != nil {
```

##### 生成 CRI 容器已创建事件
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:993 (PC: 0x32afdd1)
=> 993:		s.generateCRIEvent(ctx, sb.InfraContainer(), types.ContainerEventType_CONTAINER_CREATED_EVENT)
   994:		if err := s.Runtime().StartContainer(ctx, container); err != nil {
   995:			return nil, err
   996:		}
```

##### 启动 infraContainer：拉起 pause 进程，复用 crio-crun 进程上下文空间，即进程号不变
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:994 (PC: 0x32afe0e)
   993:		s.generateCRIEvent(ctx, sb.InfraContainer(), types.ContainerEventType_CONTAINER_CREATED_EVENT)
=> 994:		if err := s.Runtime().StartContainer(ctx, container); err != nil {
   995:			return nil, err
   996:		}
```

查看节点进程信息，pause 进程被拉起，如下：
```
      1    8243    8242    1786 pts/3       3818 Sl       0   0:00 /usr/bin/crio-conmonrs --runtime /usr/bin/crio-crun --runtime-dir /var/lib/containers/storage/overlay-containers/d23ea07c20b1d1fbd886fb088663e5a81cb6b82e2424ce38afb5b4490c1a4f93/userdata --runtime-root /run/crun --log-level debug --log-driver systemd --cgroup-manager systemd
   8243    8251    8251    8251 ?             -1 Ss       0   0:00  \_ /pause
```

##### 容器状态信息落盘
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:1014 (PC: 0x32b0053)
  1013:
=>1014:		if err := s.ContainerStateToDisk(ctx, container); err != nil {
  1015:			log.Warnf(ctx, "Unable to write containers %s state to disk: %v", container.ID(), err)
  1016:		}
  1017:
```

##### sb sandbox 添加 ips 信息
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:1018 (PC: 0x32b0229)
  1017:
=>1018:		for idx, ip := range ips {
  1019:			g.AddAnnotation(fmt.Sprintf("%s.%d", annotations.IP, idx), ip)
  1020:		}
  1021:		sb.AddIPs(ips)
```

##### 调用 NRI，传递 sandbox 配置
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:1023 (PC: 0x32b043b)
  1022:
=>1023:		if err := s.nri.runPodSandbox(ctx, sb); err != nil {
  1024:			return nil, err
  1025:		}
```

此处未配置 NRI，所以直接退出。

##### runPodSandbox 请求完成，返回 RunPodSandboxResponse，返回值携带 sandbox id
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./server/sandbox_run_linux.go:1042 (PC: 0x32b0b12)
  1041:		log.Infof(ctx, "Ran pod sandbox %s with infra container: %s", container.ID(), container.Description())
=>1042:		resp = &types.RunPodSandboxResponse{PodSandboxId: sbox.ID()}
  1043:		return resp, nil
  1044:	}
```

返回值，如下：
```
> github.com/cri-o/cri-o/server.(*Server).RunPodSandbox() ./server/sandbox_run.go:69 (PC: 0x329fe2f)
Values returned:
	resp: ("*k8s.io/cri-api/pkg/apis/runtime/v1.RunPodSandboxResponse")(0xc000528048)
*k8s.io/cri-api/pkg/apis/runtime/v1.RunPodSandboxResponse {
		PodSandboxId: "d23ea07c20b1d1fbd886fb088663e5a81cb6b82e2424ce38afb5b4490c1a4f93",
		XXX_NoUnkeyedLiteral: struct {} {},
		XXX_sizecache: 0,}
	retErr: error nil
```

##### 生成 InfraContainer 已启动事件
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:1039 (PC: 0x32b0972)
  1038:		sb.SetCreated()
=>1039:		s.generateCRIEvent(ctx, sb.InfraContainer(), types.ContainerEventType_CONTAINER_STARTED_EVENT)
  1040:
```

##### 构建 gRPC 请求响应体 types.RunPodSandboxResponse
```
> github.com/cri-o/cri-o/server.(*Server).runPodSandbox() ./go.linux/src/github.com/Bevisy/cri-o/server/sandbox_run_linux.go:1042 (PC: 0x32b0b12)
  1041:		log.Infof(ctx, "Ran pod sandbox %s with infra container: %s", container.ID(), container.Description())
=>1042:		resp = &types.RunPodSandboxResponse{PodSandboxId: sbox.ID()}
  1043:		return resp, nil
  1044:	}
```

### server.(\*Server).RunPodSandbox() 完成
```
> github.com/cri-o/cri-o/server.(*Server).RunPodSandbox() ./server/sandbox_run.go:69 (PC: 0x329fe2f)
    65:
    66:	// RunPodSandbox creates and runs a pod-level sandbox.
    67:	func (s *Server) RunPodSandbox(ctx context.Context, req *types.RunPodSandboxRequest) (*types.RunPodSandboxResponse, error) {
    68:		// platform dependent call
=>  69:		return s.runPodSandbox(ctx, req)
    70:	}
    71:
```

返回值，如下：
```
> k8s.io/cri-api/pkg/apis/runtime/v1._RuntimeService_RunPodSandbox_Handler.func1() ./vendor/k8s.io/cri-api/pkg/apis/runtime/v1/api.pb.go:11260 (PC: 0x1e569f4)
Values returned:
	~r0: ("*k8s.io/cri-api/pkg/apis/runtime/v1.RunPodSandboxResponse")(0xc000528048)
*k8s.io/cri-api/pkg/apis/runtime/v1.RunPodSandboxResponse {
		PodSandboxId: "d23ea07c20b1d1fbd886fb088663e5a81cb6b82e2424ce38afb5b4490c1a4f93",
		XXX_NoUnkeyedLiteral: struct {} {},
		XXX_sizecache: 0,}
	~r1: error nil
```

### 返回 k8s.io/cri-api/pkg/apis/runtime/v1 包，即 CRI API Interface
```
> k8s.io/cri-api/pkg/apis/runtime/v1._RuntimeService_RunPodSandbox_Handler.func1() ./vendor/k8s.io/cri-api/pkg/apis/runtime/v1/api.pb.go:11260 (PC: 0x1e569f4)
  11255:		info := &grpc.UnaryServerInfo{
  11256:			Server:     srv,
  11257:			FullMethod: "/runtime.v1.RuntimeService/RunPodSandbox",
  11258:		}
  11259:		handler := func(ctx context.Context, req interface{}) (interface{}, error) {
=>11260:			return srv.(RuntimeServiceServer).RunPodSandbox(ctx, req.(*RunPodSandboxRequest))
  11261:		}
  11262:		return interceptor(ctx, in, info, handler)
  11263:	}
```

### gRPC 包发送 Response，RunPodSandbox() 流程结束
```
> google.golang.org/grpc.(*Server).processUnaryRPC() ./go.linux/src/github.com/Bevisy/cri-o/vendor/google.golang.org/grpc/server.go:1426 (PC: 0x1dec8a3)
  1421:		// Server handler could have set new compressor by calling SetSendCompressor.
  1422:		// In case it is set, we need to use it for compressing outbound message.
  1423:		if stream.SendCompress() != sendCompressorName {
  1424:			comp = encoding.GetCompressor(stream.SendCompress())
  1425:		}
=>1426:		if err := s.sendResponse(ctx, t, stream, reply, cp, opts, comp); err != nil {
  1427:			if err == io.EOF {
  1428:				// The entire stream is done (for unary RPC only).
  1429:				return err
  1430:			}
```
